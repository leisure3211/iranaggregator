<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRAN TENSION MONITOR v9.2 ‚Äî LIVE FEED</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="icon" href="data:,">
<style>
:root {
  --bg: #0f1923; --panel: #162030; --panel-dark: #0d1520;
  --border: #253a52; --text: #d4e6f8; --text-dim: #8899aa; --bright: #ffffff;
  --accent: #29b6f6; --danger: #f44336; --warn: #ffa726; --green: #4caf50;
  --purple: #ab47bc; --pizza: #ff7043;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; background: var(--bg); color: var(--text); }

#header {
  height: 42px; background: #0a1218; border-bottom: 2px solid var(--accent);
  display: flex; align-items: center; padding: 0 12px; gap: 10px; flex-shrink: 0; z-index: 300;
}
.logo { font-size: 16px; font-weight: 700; color: #fff; white-space: nowrap; }
.badge { background: #29b6f618; border: 1px solid var(--accent); color: var(--accent); padding: 2px 7px; border-radius: 3px; font-size: 11px; white-space: nowrap; }
#ticker { flex: 1; font-size: 12px; color: var(--warn); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: opacity 0.3s; }
#clock { font-size: 14px; color: var(--accent); font-family: 'Courier New', monospace; white-space: nowrap; }
.live-dot { width: 7px; height: 7px; background: var(--danger); border-radius: 50%; animation: blink 1s infinite; flex-shrink: 0; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
.hdr-btn { cursor: pointer; padding: 3px 9px; border: 1px solid var(--border); border-radius: 3px; font-size: 12px; background: transparent; color: var(--text-dim); white-space: nowrap; transition: all 0.2s; }
.hdr-btn.on { border-color: var(--green); color: var(--green); }
.hdr-btn:hover { border-color: var(--accent); color: var(--accent); }

.collapse-btn {
  position: absolute; top: 8px; right: 8px; z-index: 10;
  background: rgba(10,18,24,0.8); border: 1px solid var(--border);
  color: var(--text-dim); padding: 4px 8px; border-radius: 3px; cursor: pointer;
  font-size: 11px; transition: all 0.2s;
}
.collapse-btn:hover { border-color: var(--accent); color: var(--accent); }
.sidebar.collapsed { width: 40px; }
.sidebar-right.collapsed { width: 40px; }
.sidebar.collapsed .section, .sidebar-right.collapsed .tab-pane { display: none; }
.sidebar.collapsed .collapse-btn::after { content: '‚Üí'; }
.sidebar-right.collapsed .collapse-btn::after { content: '‚Üê'; }

#main { display: flex; height: calc(100vh - 42px); overflow: hidden; }

.sidebar, .sidebar-right {
  background: var(--panel-dark); border-color: var(--border);
  overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; flex-shrink: 0;
  position: relative; transition: width 0.3s ease;
}
.sidebar { width: 270px; border-right: 1px solid var(--border); }
.sidebar-right { width: 340px; border-left: 1px solid var(--border); }

#center { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
#map-wrap { height: 50%; position: relative; border-bottom: 2px solid var(--accent); flex-shrink: 0; }
#map { height: 100%; width: 100%; }
#news-center { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: var(--panel-dark); }
#news-center-header {
  height: 36px; background: #0a1218; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 12px; gap: 10px; flex-shrink: 0;
}
#news-center-header .nc-title { font-size: 12px; font-weight: 700; color: var(--accent); }
#news-center-header .nc-sources { font-size: 10px; color: var(--text-dim); flex: 1; }
#news-center-header .nc-count { font-family: 'Courier New', monospace; font-size: 11px; color: var(--green); }
#news-stream { flex: 1; overflow-y: auto; padding: 0; }

.ns-item {
  display: flex; gap: 10px; padding: 8px 12px;
  border-bottom: 1px solid #162030; transition: background 0.2s; cursor: pointer; align-items: flex-start;
}
.ns-item:hover { background: #122035; }
.ns-item.BREAKING { border-left: 3px solid var(--danger); background: #f4433608; }
.ns-item.MILITARY { border-left: 3px solid var(--warn); }
.ns-item.DIPLOMATIC { border-left: 3px solid var(--purple); }
.ns-item.ECONOMIC { border-left: 3px solid var(--green); }
.ns-item.OSINT { border-left: 3px solid var(--pizza); }
.ns-item.new-flash { animation: flashNew 3s ease; }
@keyframes flashNew { 0%{background:#29b6f625}100%{} }
.ns-source-logo {
  width: 36px; height: 36px; border-radius: 4px; display: flex; align-items: center;
  justify-content: center; font-size: 10px; font-weight: 700; color: #fff;
  flex-shrink: 0; text-align: center; line-height: 1.2;
}
.ns-body { flex: 1; min-width: 0; }
.ns-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; flex-wrap: wrap; }
.ns-source-name { font-size: 10px; font-weight: 700; color: var(--text-dim); }
.ns-time { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; }
.ns-cat { font-size: 9px; padding: 1px 5px; border-radius: 2px; font-weight: 700; letter-spacing: 0.5px; }
.ns-cat.BREAKING { background: #f4433625; color: var(--danger); border: 1px solid #f4433650; }
.ns-cat.MILITARY { background: #ffa72620; color: var(--warn); border: 1px solid #ffa72650; }
.ns-cat.DIPLOMATIC { background: #ab47bc20; color: var(--purple); border: 1px solid #ab47bc50; }
.ns-cat.ECONOMIC { background: #4caf5020; color: var(--green); border: 1px solid #4caf5050; }
.ns-cat.OSINT { background: #ff704320; color: var(--pizza); border: 1px solid #ff704350; }
.ns-headline { font-size: 12px; font-weight: 600; color: var(--bright); line-height: 1.4; }
.ns-summary { font-size: 11px; color: var(--text-dim); margin-top: 2px; line-height: 1.3; }
.ns-read { font-size: 10px; color: var(--accent); margin-top: 3px; }
.ns-tts-btn { font-size: 16px; cursor: pointer; opacity: 0.5; flex-shrink: 0; margin-top: 2px; transition: opacity 0.2s; }
.ns-tts-btn:hover { opacity: 1; }

.section { border-bottom: 1px solid var(--border); padding: 9px 11px; }
.sec-title { font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 7px; display: flex; align-items: center; gap: 6px; }
.sec-title.red { color: var(--danger); }
.sec-title.orange { color: var(--warn); }
.sec-title.green { color: var(--green); }
.sec-title.pizza { color: var(--pizza); }

.tooltip {
  position: relative; cursor: help;
  border-bottom: 1px dotted var(--text-dim);
}
.tooltip::after {
  content: attr(data-tooltip);
  position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
  background: rgba(10,18,24,0.95); color: var(--text);
  padding: 4px 8px; border-radius: 3px; font-size: 11px; white-space: nowrap;
  opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1000;
}
.tooltip:hover::after { opacity: 1; }

.sparkline {
  width: 40px; height: 12px; margin-left: 8px;
  background: linear-gradient(to right,
    transparent 0%, transparent 45%,
    var(--accent) 45%, var(--accent) 55%,
    transparent 55%, transparent 70%,
    var(--warn) 70%, var(--warn) 80%,
    transparent 80%, transparent 100%
  );
  border-radius: 2px; opacity: 0.7;
}
.sparkline.up { background: linear-gradient(to right, var(--green) 0%, var(--green) 100%); }
.sparkline.down { background: linear-gradient(to right, var(--danger) 0%, var(--danger) 100%); }

.stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #1a2d40; font-size: 13px; }
.stat-row .lbl { color: var(--text-dim); font-weight: 500; }
.stat-row .val { font-family: 'Courier New', monospace; font-weight: 700; }
.stat-row .val.red { color: var(--danger); }
.stat-row .val.orange { color: var(--warn); }
.stat-row .val.green { color: var(--green); }

#risk-wrap { text-align: center; padding: 4px 0 2px; }
#risk-wrap svg { transform: rotate(-90deg); }
#ring-bg { fill: none; stroke: #1e3048; stroke-width: 10; }
#ring-fill { fill: none; stroke-width: 10; stroke-linecap: round; stroke: var(--danger); transition: stroke-dashoffset 1.5s; }
#risk-num { font-size: 26px; font-weight: 700; color: var(--danger); }
#risk-sub { font-size: 10px; color: var(--text-dim); }
.risk-badge { text-align: center; padding: 3px; border-radius: 3px; font-size: 11px; font-weight: 700; margin-bottom: 7px; background: #f4433618; border: 1px solid var(--danger); color: var(--danger); }

.sig-row { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
.sig-name { font-size: 10px; color: var(--text-dim); width: 88px; flex-shrink: 0; }
.sig-bg { flex: 1; height: 5px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.sig-fill { height: 100%; border-radius: 3px; transition: width 1.5s; }
.sig-val { font-size: 10px; font-family: 'Courier New', monospace; width: 26px; text-align: right; color: var(--text-dim); }

.filter-row { display: flex; flex-wrap: wrap; gap: 4px; margin: 5px 0; }
.filter-btn { background: #0d1a28; border: 1px solid var(--border); color: var(--text-dim); padding: 2px 8px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
.filter-btn.active { background: #29b6f618; border-color: var(--accent); color: var(--accent); }

.src-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #1a2d40; font-size: 10px; }
.src-name { color: var(--text-dim); }
.src-ok { color: var(--green); font-family: 'Courier New', monospace; }
.src-loading { color: var(--warn); }

#map-controls { position: absolute; top: 8px; left: 8px; z-index: 500; display: flex; flex-direction: column; gap: 4px; }
.map-btn { background: rgba(10,18,24,0.9); border: 1px solid var(--border); color: var(--text); padding: 4px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.map-btn:hover { border-color: var(--accent); color: var(--accent); }
.map-btn.active { background: #29b6f612; border-color: var(--accent); color: var(--accent); }

#map-banner { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); z-index: 500; background: rgba(10,18,24,0.95); border: 1px solid var(--warn); border-radius: 4px; padding: 5px 12px; font-size: 11px; color: var(--warn); display: none; white-space: nowrap; }
#map-banner.show { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)} }

.tab-bar { display: flex; background: #0a1218; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.tab { flex: 1; padding: 7px 3px; text-align: center; font-size: 10px; font-weight: 700; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); background: #29b6f60c; }
.tab-pane { display: none; overflow-y: auto; padding: 9px 11px; flex: 1; }
.tab-pane.active { display: block; }
#tab-briefing { line-height: 1.5; }
#tab-briefing h3 { font-size: 14px; color: var(--accent); margin: 12px 0 6px 0; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
#tab-briefing h4 { font-size: 12px; color: var(--warn); margin: 10px 0 5px 0; }
#tab-briefing p, #tab-briefing li { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
#tab-briefing a { color: var(--accent); text-decoration: none; }
#tab-briefing a:hover { text-decoration: underline; }
#tab-briefing ul { list-style-position: inside; padding-left: 0; }
#tab-briefing .case-study { background: #0d1a28; border-left: 3px solid var(--purple); padding: 8px; margin: 8px 0; border-radius: 4px;}


.rn-item { padding: 6px 8px; margin: 4px 0; border-left: 3px solid var(--accent); background: #0d1a28; border-radius: 0 4px 4px 0; font-size: 11px; }
.rn-item.mil { border-left-color: var(--danger); }
.rn-item.dip { border-left-color: var(--purple); }
.rn-item.eco { border-left-color: var(--green); }
.rn-item.osint { border-left-color: var(--pizza); }
.rn-time { font-size: 10px; color: var(--text-dim); margin-bottom: 2px; font-family: 'Courier New', monospace; }
.rn-headline { color: var(--bright); font-weight: 600; line-height: 1.3; }
.rn-why { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-style: italic; }

.x-item { padding: 6px 8px; margin: 4px 0; background: #0d1a28; border: 1px solid #1e3048; border-radius: 4px; font-size: 11px; }
.x-handle { color: var(--accent); font-weight: 700; }
.x-time { color: var(--text-dim); font-size: 10px; float: right; font-family: 'Courier New', monospace; }
.x-text { color: var(--text); line-height: 1.4; margin-top: 3px; }

.pizza-bar-row { margin: 4px 0; }
.pbl { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px; }
.pbl .pct { font-family: 'Courier New', monospace; font-weight: 700; color: var(--pizza); }
.pb-bg { height: 7px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.pb-fill { height: 100%; border-radius: 3px; background: var(--pizza); transition: width 2s; }
.pizza-defcon { display: flex; gap: 4px; justify-content: center; margin: 6px 0; }
.pizza-pip { width: 30px; height: 30px; border: 2px solid #1a2d40; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.pizza-pip.on { border-color: var(--pizza); box-shadow: 0 0 8px #ff704330; }
.pizza-pip.hot { border-color: var(--danger); box-shadow: 0 0 12px #f4433660; animation: hotpip 0.8s infinite; }
@keyframes hotpip { 0%,100%{box-shadow:0 0 8px #f4433640}50%{box-shadow:0 0 18px #f44336} }

.pm-row { padding: 5px 8px; margin: 3px 0; background: #0d1a28; border: 1px solid var(--border); border-radius: 4px; position: relative; overflow: hidden; }
.pm-bg { position: absolute; left: 0; top: 0; bottom: 0; opacity: 0.1; background: var(--danger); }
.pm-label { font-size: 10px; color: var(--text-dim); margin-bottom: 2px; position: relative; }
.pm-val { font-size: 16px; font-weight: 700; color: var(--danger); font-family: 'Courier New', monospace; position: relative; }
.pm-vol { font-size: 10px; color: var(--text-dim); position: relative; }
.pm-row.warn .pm-bg { background: var(--warn); }
.pm-row.warn .pm-val { color: var(--warn); }

.kri-row { display: flex; align-items: center; gap: 7px; padding: 4px 0; border-bottom: 1px solid #1a2d40; }
.kri-icon { font-size: 15px; width: 22px; text-align: center; flex-shrink: 0; }
.kri-body { flex: 1; }
.kri-lbl { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-bottom: 2px; }
.kri-status.red { color: var(--danger); font-weight: 700; }
.kri-status.orange { color: var(--warn); font-weight: 700; }
.kri-status.green { color: var(--green); font-weight: 700; }
.kri-bar-bg { height: 4px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.kri-bar-fill { height: 100%; border-radius: 3px; }
.kri-bar-fill.red { background: var(--danger); }
.kri-bar-fill.orange { background: var(--warn); }
.kri-bar-fill.green { background: var(--green); }
.kri-bar-fill.crit { background: var(--danger); animation: cpulse 1s infinite; }
@keyframes cpulse { 0%,100%{opacity:0.8}50%{opacity:1} }

.sc-card { padding: 7px 9px; margin: 4px 0; background: #0d1a28; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; transition: border-color 0.2s; }
.sc-card:hover { border-color: var(--accent); }
.sc-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.sc-title { font-weight: 700; font-size: 12px; }
.sc-prob { font-size: 15px; font-weight: 700; font-family: 'Courier New', monospace; }
.sc-prob.red { color: var(--danger); }
.sc-prob.green { color: var(--green); }
.sc-prob.orange { color: var(--warn); }
.sc-desc { font-size: 10px; color: var(--text-dim); line-height: 1.4; }
#mc-result { font-size: 10px; margin-top: 7px; font-family: 'Courier New', monospace; color: var(--text-dim); white-space: pre; }

#notif-container { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 9000; display: flex; flex-direction: column-reverse; gap: 5px; pointer-events: none; max-width: 560px; width: 95%; }
.notif { background: #0d1a28; border: 1px solid var(--accent); border-left: 4px solid var(--accent); border-radius: 4px; padding: 7px 11px; font-size: 11px; animation: slideUp 0.3s ease, fadeOut 0.5s ease 8.5s forwards; pointer-events: all; display: flex; align-items: flex-start; gap: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
.notif.nred { border-color: var(--danger); border-left-color: var(--danger); }
.notif.norange { border-color: var(--warn); border-left-color: var(--warn); }
.notif.ngreen { border-color: var(--green); border-left-color: var(--green); }
.notif.npizza { border-color: var(--pizza); border-left-color: var(--pizza); }
.notif-icon { font-size: 18px; flex-shrink: 0; }
.notif-body { flex: 1; }
.notif-title { font-weight: 700; color: #fff; margin-bottom: 2px; font-size: 12px; }
.notif-detail { color: var(--text-dim); line-height: 1.3; }
.notif-time { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; white-space: nowrap; flex-shrink: 0; }
@keyframes slideUp { from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1} }
@keyframes fadeOut { from{opacity:1;pointer-events:all}to{opacity:0;pointer-events:none} }

#tts-indicator { position: fixed; top: 50px; right: 12px; background: #0d1a28; border: 1px solid var(--green); border-radius: 4px; padding: 4px 10px; font-size: 11px; color: var(--green); z-index: 9001; display: none; }
#tts-indicator.show { display: flex; align-items: center; gap: 6px; }
.tts-wave { display: flex; gap: 2px; align-items: center; }
.tts-bar { width: 3px; border-radius: 2px; background: var(--green); animation: wave 0.8s ease-in-out infinite; }
.tts-bar:nth-child(2) { animation-delay: 0.1s; }
.tts-bar:nth-child(3) { animation-delay: 0.2s; }
.tts-bar:nth-child(4) { animation-delay: 0.15s; }
@keyframes wave { 0%,100%{height:4px}50%{height:14px} }

#bottom-bar { height: 30px; background: #0a1218; border-top: 1px solid var(--border); display: flex; align-items: center; overflow: hidden; flex-shrink: 0; }
.tick { white-space: nowrap; padding: 0 12px; font-size: 10px; font-family: 'Courier New', monospace; color: var(--text-dim); border-right: 1px solid var(--border); flex-shrink: 0; }
.tick .up { color: var(--green); }
.tick .dn { color: var(--danger); }
.tick .wn { color: var(--warn); }

.btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 5px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; width: 100%; margin-top: 5px; font-family: 'Segoe UI', Arial, sans-serif; transition: all 0.2s; }
.btn:hover { background: var(--accent); color: #0d1520; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

#scan-status { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; margin-top: 4px; text-align: center; }

.leaflet-container { background: #0d1a28 !important; }
.emoji-marker { font-size: 18px; line-height: 1; filter: drop-shadow(0 0 3px rgba(41,182,246,0.6)); }
.emoji-marker.tanker { font-size: 24px; filter: drop-shadow(0 0 5px rgba(255,112,67,0.9)); }
.emoji-marker.carrier { font-size: 26px; filter: drop-shadow(0 0 7px rgba(244,67,54,0.9)); }
.leaflet-popup-content-wrapper { background: #162030; border: 1px solid var(--border); color: var(--text); border-radius: 5px; font-size: 13px; }
.leaflet-popup-tip { background: #162030; }

.marker-cluster-small { background-color: rgba(41, 182, 246, 0.6); }
.marker-cluster-medium { background-color: rgba(41, 182, 246, 0.8); }
.marker-cluster-large { background-color: rgba(41, 182, 246, 1.0); }
.marker-cluster {
  background-clip: padding-box;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  text-align: center;
  font-family: 'Courier New', monospace;
}
.marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: 12px bold; }
.marker-cluster span { line-height: 30px; }

.nato-icon {
  width: 20px; height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 12px;
  color: white;
  border-radius: 50%;
}
.nato-fighter { background: #4CAF50; }
.nato-tanker { background: #FF9800; }
.nato-awacs { background: #2196F3; }
.nato-stealth { background: #9C27B0; }
.nato-bomber { background: #F44336; }

.new-badge { display: inline-block; background: var(--danger); color: #fff; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 10px; margin-left: 4px; vertical-align: middle; }

#news-popup {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.8); z-index: 10000;
  display: none; align-items: center; justify-content: center;
}
#news-popup.show { display: flex; }
#news-popup-content {
  background: var(--panel); border: 2px solid var(--accent);
  border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80vh;
  overflow-y: auto; position: relative;
}
#news-popup-close {
  position: absolute; top: 10px; right: 10px;
  background: var(--danger); color: white;
  border: none;
  border-radius: 50%; width: 30px; height: 30px;
  font-size: 16px; cursor: pointer; font-weight: bold;
}
#news-popup-close:hover { background: #d32f2f; }
#news-popup-title {
  font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 10px; line-height: 1.3; }
#news-popup-meta {
  font-size: 12px; color: var(--text-dim); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
#news-popup-source { font-weight: 700; color: var(--accent); }
#news-popup-time { font-family: 'Courier New', monospace; }
#news-popup-body {
  font-size: 16px; line-height: 1.5; color: var(--text); margin-bottom: 15px; }
#news-popup-link {
  display: inline-block; background: var(--accent); color: var(--bg); padding: 8px 16px; border-radius: 4px; text-decoration: none; font-weight: 600; font-size: 14px; margin-top: 10px; }
#news-popup-link:hover { background: #1e88e5; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: #0a1218; }
::-webkit-scrollbar-thumb { background: #253a52; border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }
input[type=range] { width: 100%; accent-color: var(--accent); margin: 3px 0; }
</style>
</head>
<body>

<div id="header">
  <div class="logo">üåç IRAN TENSION MONITOR</div>
  <div class="badge">v9.2 LIVE</div>
  <div class="live-dot"></div>
  <div id="ticker">‚ö° SCANNING LIVE SOURCES‚Ä¶</div>
  <button class="hdr-btn" id="sound-btn" onclick="toggleSound()">üîá Sound</button>
  <button class="hdr-btn" id="tts-btn" onclick="toggleTTS()">üîï TTS</button>
  <div id="clock">UTC 00:00:00</div>
</div>

<div id="tts-indicator">
  <span>üîä Reading aloud</span>
</div>
<div id="main">

<div class="sidebar" id="leftSidebar">
  <button class="collapse-btn" onclick="toggleSidebar('left')" title="Toggle sidebar">‚óÄ</button>
  <div class="section">
    <div class="sec-title red">Risk Index</div>
    <div id="risk-wrap">
      <svg width="110" height="110" viewBox="0 0 110 110">
        <circle id="ring-bg" cx="55" cy="55" r="44"/>
        <circle id="ring-fill" cx="55" cy="55" r="44" stroke-dasharray="276.5" stroke-dashoffset="72"/>
      </svg>
      <div style="margin-top:-65px;margin-bottom:34px">
        <div id="risk-num">74%</div>
        <div id="risk-sub">Threat Level</div>
      </div>
    </div>
    <div class="risk-badge">‚ö† ELEVATED ‚Äî IMMINENT WATCH</div>
    <div class="sig-row"><span class="sig-name">ADS-B Density</span><div class="sig-bg"><div class="sig-fill" style="width:82%;background:var(--danger)"></div></div><span class="sig-val" style="color:var(--danger)">82</span></div>
    <div class="sig-row"><span class="sig-name">Pred. Markets</span><div class="sig-bg"><div class="sig-fill" style="width:67%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">67</span></div>
    <div class="sig-row"><span class="sig-name">Pizza Index</span><div class="sig-bg"><div class="sig-fill" style="width:58%;background:var(--pizza)"></div></div><span class="sig-val" style="color:var(--pizza)">58</span></div>
    <div class="sig-row"><span class="sig-name">Oil / CDS</span><div class="sig-bg"><div class="sig-fill" style="width:75%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">75</span></div>
    <div class="sig-row"><span class="sig-name">Naval Posture</span><div class="sig-bg"><div class="sig-fill" style="width:91%;background:var(--danger)"></div></div><span class="sig-val" style="color:var(--danger)">91</span></div>
    <div class="sig-row"><span class="sig-name">Diplomatic</span><div class="sig-bg"><div class="sig-fill" style="width:45%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">45</span></div>
  </div>

  <div class="section">
    <div class="sec-title">Live Asset Count</div>
    <div class="stat-row"><span class="lbl">‚úàÔ∏è Military Aircraft</span><span class="val red" id="aircraftCount">‚Äî</span></div>
    <div class="stat-row"><span class="lbl">‚õΩ Tankers (orbiting)</span><span class="val orange" id="tankerCount">‚Äî</span></div>
    <div class="stat-row"><span class="lbl">üì° AWACS / Recon</span><span class="val orange" id="awacsCount">‚Äî</span></div>
    <div class="stat-row"><span class="lbl">üëª Stealth Assets</span><span class="val red" id="stealthCount">‚Äî</span></div>
    <div class="stat-row"><span class="lbl">‚öì US Carriers (Gulf)</span><span class="val red">2</span></div>
    <div class="stat-row"><span class="lbl">üö¢ Warships in Gulf</span><span class="val red">41</span></div>
    <div class="stat-row"><span class="lbl">üö´ AIS-Dark Vessels</span><span class="val red">8</span></div>
    <div class="stat-row"><span class="lbl">üõ∞Ô∏è Space Assets</span><span class="val">11</span></div>
    <div style="margin-top:8px">
      <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px">Speed Filter</div>
      <input type="range" min="0" max="600" value="0" id="speedFilter">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim)"><span>0</span><span id="speedVal" style="color:var(--accent)">0 kt</span><span>600</span></div>
    </div>
    <div class="filter-row">
      <div class="filter-btn active" onclick="setFilter(this,'all')">All</div>
      <div class="filter-btn" onclick="setFilter(this,'tanker')">‚õΩ</div>
      <div class="filter-btn" onclick="setFilter(this,'awacs')">üì°</div>
      <div class="filter-btn" onclick="setFilter(this,'stealth')">üëª</div>
      <div class="filter-btn" onclick="setFilter(this,'drone')">üõ∏</div>
      <div class="filter-btn" onclick="setFilter(this,'bomber')">üõ©Ô∏è</div>
    </div>
    <button class="btn" id="scanBtn" onclick="runScan(true)">‚ö° Manual Scan</button>
    <div id="scan-status">Auto-scan every 3 min</div>
    <div id="sourceList" style="margin-top:6px;max-height:200px;overflow-y:auto"></div>
  </div>

  <div class="section">
    <div class="sec-title orange">Markets</div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Credit Default Swap - insurance against default">üõ¢Ô∏è Brent Crude</span><span class="val red">$97.40 +12.3%<div class="sparkline down"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Credit Default Swap - insurance against default">Iran CDS</span><span class="val red">2,840 bps<div class="sparkline up"></div></span></div>
    <div class="stat-row"><span class="lbl">üí∞ Gold</span><span class="val orange">$3,218 ‚ñ≤<div class="sparkline up"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Volatility Index - market fear gauge">‚ö° VIX</span><span class="val red">34.2<div class="sparkline down"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Lockheed Martin stock">üè¶ LMT</span><span class="val green">$628 +28%YTD<div class="sparkline up"></div></span></div>
  </div>
</div>

<div id="center">
  <div id="map-wrap">
    <div id="map"></div>
    <div id="map-controls">
      <button class="map-btn active" onclick="toggleLayer(this,'mil')">‚úàÔ∏è Aircraft</button>
      <button class="map-btn active" onclick="toggleLayer(this,'naval')">üö¢ Naval</button>
      <button class="map-btn active" onclick="toggleLayer(this,'base')">üè† Bases</button>
      <button class="map-btn active" onclick="toggleLayer(this,'range')">üéØ Ranges</button>
    </div>
    <div id="map-banner"></div>
  </div>

  <div id="news-center">
    <div id="news-center-header">
      <div class="nc-title">üì° LIVE IRAN NEWS STREAM</div>
      <div class="nc-sources">Reuters ¬∑ AP ¬∑ BBC ¬∑ CNN ¬∑ Fox ¬∑ Al Jazeera ¬∑ DW ¬∑ PressTV ¬∑ RT ¬∑ Times of Israel ¬∑ Haaretz ¬∑ Guardian ¬∑ CBS ¬∑ NBC ¬∑ WSJ ¬∑ MEE ¬∑ Al Arabiya + more</div>
      <div id="nc-count" class="nc-count">0 items</div>
    </div>
    <div id="news-stream"></div>
  </div>

  <div id="bottom-bar">
    <div class="tick">üõ¢Ô∏è BRENT <span class="tooltip" data-tooltip="Credit Default Swap - insurance against default"><span class="dn">$97.40</span><div class="sparkline down"></div></span></div>
    <div class="tick">IRAN CDS <span class="tooltip" data-tooltip="Credit Default Swap - insurance against default"><span class="dn">2,840bps</span><div class="sparkline up"></div></span></div>
    <div class="tick">VIX <span class="tooltip" data-tooltip="Volatility Index - market fear gauge"><span class="dn">34.2</span><div class="sparkline down"></div></span></div>
    <div class="tick">LMT <span class="tooltip" data-tooltip="Lockheed Martin stock"><span class="up">+28%YTD</span><div class="sparkline up"></div></span></div>
    <div class="tick">TRUMP DEADLINE <span class="wn">6 DAYS</span></div>
    <div class="tick">POLYMARKET BY JUN30 <span class="dn">67%</span></div>
    <div class="tick">KALSHI <span class="wn">$87M VOL</span></div>
    <div class="tick">TANKER ORBITS <span class="dn">ACTIVE</span></div>
  </div>
</div>

<div class="sidebar-right" id="rightSidebar">
  <button class="collapse-btn" onclick="toggleSidebar('right')" title="Toggle sidebar">‚ñ∂</button>
  <div class="tab-bar">
    <div class="tab active" onclick="showTab(this,'osint')">ùïè OSINT</div>
    <div class="tab" onclick="showTab(this,'poly')">üìä Poly</div>
    <div class="tab" onclick="showTab(this,'pizza')">üçï Pizza</div>
    <div class="tab" onclick="showTab(this,'kri')">üéØ KRI</div>
    <div class="tab" onclick="showTab(this,'scenario')">üé≤ Scenarios</div>
    <div class="tab" onclick="showTab(this,'briefing')">üìñ Briefing</div>
  </div>

  <div class="tab-pane active" id="tab-osint">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Live OSINT ‚Äî unverified, cross-reference</div>
    <div id="x-feed"></div>
  </div>

  <div class="tab-pane" id="tab-poly">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Real-money prediction markets ¬∑ $207M+ total</div>
    <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:5px">US Strikes Iran by‚Ä¶</div>
    <div class="pm-row"><div class="pm-bg" style="width:25%"></div><div class="pm-label">Feb 28, 2026</div><div class="pm-val">25%</div><div class="pm-vol">$11.2M volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:44%"></div><div class="pm-label">Mar 31, 2026</div><div class="pm-val">44%</div><div class="pm-vol">$7.4M volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:67%"></div><div class="pm-label">Jun 30, 2026 ‚Üê frontrunner</div><div class="pm-val">67%</div><div class="pm-vol">$207M total volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:73%"></div><div class="pm-label">Dec 31, 2026</div><div class="pm-val">73%</div><div class="pm-vol">Year-end cumulative</div></div>
    <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin:8px 0 5px">Iran Strikes US by‚Ä¶</div>
    <div class="pm-row warn"><div class="pm-bg" style="width:16%"></div><div class="pm-label">Feb 28, 2026</div><div class="pm-val">16%</div><div class="pm-vol">$157K volume</div></div>
    <div class="pm-row warn"><div class="pm-bg" style="width:33%"></div><div class="pm-label">Mar 31, 2026</div><div class="pm-val">33%</div><div class="pm-vol">$39.5M volume</div></div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:7px">Kalshi (regulated): $87M Iran conflict volume</div>
  </div>

  <div class="tab-pane" id="tab-pizza">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px;line-height:1.4">Google Maps "Popular Times" at 6 Arlington pizzerias within 2.5mi of Pentagon. Surge >400% historically precedes major ops.</div>
    <div style="font-size:11px;font-weight:700;margin-bottom:5px">DEFCON</div>
    <div class="pizza-defcon" id="pizza-defcon">
      <div class="pizza-pip on">üçï</div><div class="pizza-pip on">üçï</div><div class="pizza-pip on">üçï</div><div class="pizza-pip">üçï</div><div class="pizza-pip">üçï</div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);margin-bottom:8px"><span>Normal</span><span style="color:var(--pizza)">Elevated</span><span style="color:var(--danger)">Crisis</span></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Papa John's (0.5mi)</span><span class="pct" id="pj-pct">+58%</span></div><div class="pb-bg"><div class="pb-fill" id="pj-bar" style="width:58%"></div></div></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Domino's (1.2mi)</span><span class="pct" id="dom-pct">+34%</span></div><div class="pb-bg"><div class="pb-fill" id="dom-bar" style="width:34%"></div></div></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Extreme Pizza (2.5mi)</span><span class="pct" id="ep-pct">+12%</span></div><div class="pb-bg"><div class="pb-fill" id="ep-bar" style="width:12%;background:var(--green)"></div></div></div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:8px;line-height:1.4">Historical: Gulf War +2,000% ‚úì ¬∑ Op. Neptune Spear surge ‚úì ¬∑ Iran drones Apr 2024 ‚úì ¬∑ Israel strikes Iran Jun 2025 ‚úì ¬∑ Venezuela Jan 2026 +400% ‚úì ¬∑ Jan 5 2026 +1,250% ‚ö† pending</div>
    <div style="margin-top:6px"><a href="https://www.pizzint.watch" target="_blank" style="font-size:10px;color:var(--accent)">‚Üí pizzint.watch</a></div>
  </div>

  <div class="tab-pane" id="tab-kri">
    <div class="kri-row"><div class="kri-icon">‚öì</div><div class="kri-body"><div class="kri-lbl"><span>Carrier Strike Groups</span><span class="kri-status red">2/2 DEPLOYED</span></div><div class="kri-bar-bg"><div class="kri-bar-fill crit" style="width:100%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">‚õΩ</div><div class="kri-body"><div class="kri-lbl"><span>Tanker Orbits</span><span class="kri-status red">PERSISTENT</span></div><div class="kri-bar-bg"><div class="kri-bar-fill red" style="width:87%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üõ¢Ô∏è</div><div class="kri-body"><div class="kri-lbl"><span>Oil Spike</span><span class="kri-status orange">+12.3%</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:75%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üì°</div><div class="kri-body"><div class="kri-lbl"><span>AWACS Presence</span><span class="kri-status orange">ELEVATED</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:80%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üö´</div><div class="kri-body"><div class="kri-lbl"><span>AIS-Dark Vessels</span><span class="kri-status red">8 SHIPS</span></div><div class="kri-bar-bg"><div class="kri-bar-fill crit" style="width:92%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üí¨</div><div class="kri-body"><div class="kri-lbl"><span>Diplomatic Channels</span><span class="kri-status orange">OMAN TALKS</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:45%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üõ∞Ô∏è</div><div class="kri-body"><div class="kri-lbl"><span>Satellite Tasking</span><span class="kri-status red">HIGH PRI</span></div><div class="kri-bar-bg"><div class="kri-bar-fill red" style="width:83%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">üåê</div><div class="kri-body"><div class="kri-lbl"><span>Iran Internet</span><span class="kri-status green">NOMINAL</span></div><div class="kri-bar-bg"><div class="kri-bar-fill green" style="width:20%"></div></div></div></div>
  </div>

  <div class="tab-pane" id="tab-scenario">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Monte Carlo ¬∑ 1,000 runs ¬∑ based on live KRI</div>
    <div class="sc-card" onclick="showScenario('limited')"><div class="sc-hdr"><span class="sc-title">üéØ Limited Strike</span><span class="sc-prob red">54%</span></div><div class="sc-desc">B-2 + Tomahawks on Natanz/Fordow. 36-72hr window. Similar to Jun 2025.</div></div>
    <div class="sc-card" onclick="showScenario('major')"><div class="sc-hdr"><span class="sc-title">üí• Major Escalation</span><span class="sc-prob red">23%</span></div><div class="sc-desc">Multi-site strikes + Iran proxy retaliation. Hormuz threatened.</div></div>
    <div class="sc-card" onclick="showScenario('diplomatic')"><div class="sc-hdr"><span class="sc-title">üïäÔ∏è Diplomatic Deal</span><span class="sc-prob green">17%</span></div><div class="sc-desc">Oman talks succeed. Enrichment freeze. Carriers withdraw.</div></div>
    <div class="sc-card" onclick="showScenario('cyber')"><div class="sc-hdr"><span class="sc-title">üå´Ô∏è Cyber / Gray Zone</span><span class="sc-prob orange">6%</span></div><div class="sc-desc">Stuxnet 2.0 on centrifuges. No kinetic strike.</div></div>
    <button class="btn" onclick="runMonteCarlo()">‚ö° Run Monte Carlo</button>
    <div id="mc-result"></div>
  </div>

  <div class="tab-pane" id="tab-briefing">
    <h3>Executive Summary</h3>
    <p>OSINT used to anticipate Iran‚ÄìU.S. escalation relies on four core evidence streams ‚Äî movement & positioning (ships, aircraft, troops), imagery & geolocation (satellite & photo/video), signal/metadata trails (telecom, AIS, FlightRadar, social), and documentary/financial trails (declarations, sanctions data, ship ownership). Analysts combine them with pattern models and human-intel (media, dissidents, local fixers) to produce warnings, likelihood scores, and attributions. (<a href="https://c4ads.org/commentary/2020-4-21-hull-in-their-story/?utm_source=chatgpt.com" target="_blank">C4ADS</a>)</p>

    <h3>Categorized Methods & Examples</h3>
    
    <h4>1. Surface & Maritime Tracking</h4>
    <p>Tracking commercial and naval vessel movements using AIS feeds, satellite photos, port logs and vessel registries to detect covert or unusual concentration of ships, darkened (AIS-off) tankers, or ship-to-ship transfers that presage sanctions-evasion, convoying for offensive logistics, or covert resupply. Analysts aggregate AIS feeds (MarineTraffic), cross-check with satellite imagery, and flag discrepancies. Example: C4ADS documented Iranian tanker cloaking and unusual port activity around the 2019‚Äì2021 tanker incidents. (<a href="https://c4ads.org/commentary/2020-4-21-hull-in-their-story/?utm_source=chatgpt.com" target="_blank">C4ADS</a>)</p>

    <h4>2. Commercial Satellite Imagery Analysis</h4>
    <p>Using Planet, Maxar and other commercial imagery to detect buildup at airbases, visible repairs after strikes, new construction (bunkers, tunnels), or massing of equipment that precede offensive operations. Example: analysts used Planet/Maxar imagery to identify expansion of missile production facilities. (<a href="https://www.reuters.com/world/middle-east/satellite-photos-show-iran-expanding-missile-production-sources-say-2024-07-08/?utm_source=chatgpt.com" target="_blank">Reuters</a>)</p>

    <h4>3. Social-Media Geolocation & Forensics</h4>
    <p>Extracting geospatial and temporal information from publicly posted photos and videos to place events in time/place. Example: independent investigators have geolocated missile-strike videos after the January 2020 escalation to confirm timing and origin. (<a href="https://www.bellingcat.com/tag/iran/?utm_source=chatgpt.com" target="_blank">bellingcat</a>)</p>

    <h4>4. Signals & Telecom Pattern Analysis</h4>
    <p>Monitoring patterns in local telecom (sudden blackouts, jamming), spikes in messaging-app activity (Telegram), or open radio communications. (<a href="https://medium.com/%40simone.kraus/a-72-hour-research-note-as-early-warning-for-iran-ef39cfd2beb3?utm_source=chatgpt.com" target="_blank">Medium</a>)</p>
    
    <h4>5. Flight Tracking & Aircraft Movement</h4>
    <p>Using ADS-B/FlightRadar24 data to track military airlift, VIP movements, and unusual flight patterns. Example: flight pattern analysis was prominent around the lead-up to the Soleimani strike. (<a href="https://en.wikipedia.org/wiki/Assassination_of_Qasem_Soleimani?utm_source=chatgpt.com" target="_blank">Wikipedia</a>)</p>

    <h3>Concrete Historical Case Studies</h3>
    <div class="case-study">
        <h4>A. 2019‚Äì2021 Tanker Incidents</h4>
        <p>A string of incidents led analysts to use AIS, satellite imagery, and registry forensics to show ships operating ‚Äúdark‚Äù or doing ship-to-ship transfers. (<a href="https://c4ads.org/commentary/2020-4-21-hull-in-their-story/?utm_source=chatgpt.com" target="_blank">C4ADS</a>)</p>
    </div>
    <div class="case-study">
        <h4>B. Satellite Monitoring of Missile Facilities</h4>
        <p>Commercial imagery from Planet and Maxar showed expansions at missile production sites and evidence of repairs after strikes. (<a href="https://www.reuters.com/world/middle-east/satellite-photos-show-iran-expanding-missile-production-sources-say-2024-07-08/?utm_source=chatgpt.com" target="_blank">Reuters</a>)</p>
    </div>
    <div class="case-study">
        <h4>C. January 2020 ‚Äî Qasem Soleimani Strike</h4>
        <p>OSINT used social media geolocation, satellite imagery, and news aggregation to verify the strike site, timeline, and monitor reactions. (<a href="https://en.wikipedia.org/wiki/Assassination_of_Qasem_Soleimani?utm_source=chatgpt.com" target="_blank">Wikipedia</a>)</p>
    </div>

    <h3>Actionable OSINT Checklist</h3>
    <ul>
        <li>Sudden AIS darkening or unusual ship-to-ship transfers.</li>
        <li>Rapid construction or hardening at missile bases/airfields.</li>
        <li>Concentration of military airlift or VIP flights.</li>
        <li>Surge in local messaging-app chatter indicating tasking.</li>
        <li>Financial/registry anomalies in weapons/fuel logistics chains.</li>
        <li>Geolocatable photos/videos of mobilized units.</li>
    </ul>

    <h3>Further Reading</h3>
    <ul>
        <li><a href="https://www.bellingcat.com/resources/how-tos/2024/08/30/marine-oil-spill-detection-guide/?utm_source=chatgpt.com" target="_blank">Bellingcat Investigative Guides</a></li>
        <li><a href="https://c4ads.org/commentary/2020-4-21-hull-in-their-story/?utm_source=chatgpt.com" target="_blank">C4ADS on Maritime Forensics</a></li>
        <li><a href="https://www.reuters.com/world/middle-east/satellite-photos-show-iran-expanding-missile-production-sources-say-2024-07-08/?utm_source=chatgpt.com" target="_blank">Reuters Imagery-Based Reporting</a></li>
    </ul>
  </div>
</div>
</div>

<div id="notif-container"></div>

<div id="news-popup">
  <div id="news-popup-content">
    <button id="news-popup-close" onclick="closeNewsPopup()">√ó</button>
    <div id="news-popup-title"></div>
    <div id="news-popup-meta">
      <span id="news-popup-source"></span>
      <span id="news-popup-time"></span>
    </div>
    <div id="news-popup-body"></div>
    <a id="news-popup-link" href="#" target="_blank">Read Full Story ‚Üí</a>
  </div>
</div>
<script>
var soundOn = false;
var ttsOn = false;
var audioCtx = null;
var firstScan = true;
var allNews = [];
var allAircraft = [];
var prevHexes = new Set();
var currentFilter = 'all';
var scanning = false;
var scanCountdown = null;
var nextScanIn = 180;
var injIdx = 0;
var deptIdx = 0;
var xInserted = 0;
var ttsQueue = [];
var ttsSpeaking = false;
var tickIdx = 0;
function utcNow() { return new Date().toISOString().substr(11,8) + ' UTC'; }
function updateClock() { document.getElementById('clock').textContent = 'UTC ' + new Date().toISOString().substr(11,8); }
setInterval(updateClock, 1000); updateClock();

const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
const ws = new WebSocket(`${protocol}${window.location.host}`);
ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.type === 'NEWS_UPDATE') {
        const newItems = data.payload.filter(item => !allNews.some(existing => existing.h === item.h));
        allNews = data.payload;
        if (!firstScan) {
            newItems.slice(0, 3).forEach(item => {
                const isBig = item.cat === 'BREAKING' || item.cat === 'MILITARY';
                notify(
                    item.cat==='BREAKING'?'üö®':item.cat==='MILITARY'?'‚úàÔ∏è':item.cat==='DIPLOMATIC'?'üïäÔ∏è':'üì∞',
                    `[${item.src}] ${item.cat}`,
                    item.h.substr(0, 100) + (item.h.length > 100 ? '‚Ä¶' : ''),
                    isBig ? 'red' : 'orange',
                    isBig ? playChime_breaking : playChime_news
                );
                if (ttsOn) {
                    if (isBig) speak(`Breaking news from ${item.src}. ${item.h}`, true);
                    else speak(`Update from ${item.src}. ${item.h}`);
                }
            });
            if (newItems.length > 0) {
                const t = newItems[0];
                updateTickerWithNews(t.src + ': ' + t.h.substr(0, 80) + '‚Ä¶');
            }
        }
        renderNewsStream();
        firstScan = false;
    }
};
ws.onopen = function() {
    console.log('WebSocket connection established');
};
ws.onerror = function(error) {
    console.error('WebSocket Error: ' + error);
};

function toggleSound() {
  soundOn = !soundOn;
  if (soundOn && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  var b = document.getElementById('sound-btn');
  b.textContent = soundOn ? 'üîä Sound' : 'üîá Sound';
  b.className = 'hdr-btn' + (soundOn ? ' on' : '');
}
function toggleTTS() {
  ttsOn = !ttsOn;
  var b = document.getElementById('tts-btn');
  b.textContent = ttsOn ? 'üîä TTS' : 'üîï TTS';
  b.className = 'hdr-btn' + (ttsOn ? ' on' : '');
  if (!ttsOn && window.speechSynthesis) window.speechSynthesis.cancel();
}

function tone(freq, dur, vol = 0.25, shape = 'sine') {
  if (!soundOn || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = shape;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
  } catch(e){}
}
function playChime_news() {
  tone(880, 0.12, 0.2);
  setTimeout(() => tone(1100, 0.18, 0.2), 130);
}
function playChime_aircraft() {
  tone(440, 0.1, 0.18, 'square');
  setTimeout(() => tone(550, 0.1, 0.18, 'square'), 110);
  setTimeout(() => tone(660, 0.2, 0.22, 'square'), 220);
}
function playChime_breaking() {
  for (let i = 0; i < 3; i++) {
    setTimeout(() => { tone(880, 0.08, 0.3, 'sawtooth'); }, i * 200);
    setTimeout(() => { tone(660, 0.08, 0.25, 'sawtooth'); }, i * 200 + 100);
  }
}
function playChime_radar() {
  tone(1200, 0.06, 0.15);
  setTimeout(() => tone(1200, 0.04, 0.08), 300);
}
function playChime_startup() {
  tone(440, 0.1, 0.2);
  setTimeout(() => tone(554, 0.1, 0.2), 120);
  setTimeout(() => tone(660, 0.1, 0.2), 240);
  setTimeout(() => tone(880, 0.25, 0.25), 360);
}

function speak(text, priority) {
  priority = priority || false;
  if (!ttsOn || !window.speechSynthesis) return;
  if (priority) ttsQueue.unshift(text);
  else ttsQueue.push(text);
  if (!ttsSpeaking) flushTTS();
}
function flushTTS() {
  if (!ttsQueue.length || !window.speechSynthesis) { ttsSpeaking = false; document.getElementById('tts-indicator').classList.remove('show'); return; }
  ttsSpeaking = true;
  document.getElementById('tts-indicator').classList.add('show');
  var text = ttsQueue.shift();
  var u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05; u.pitch = 1; u.volume = 1;
  u.onend = function() { flushTTS(); };
  u.onerror = function() { ttsSpeaking = false; document.getElementById('tts-indicator').classList.remove('show'); };
  window.speechSynthesis.speak(u);
}

function notify(icon, title, detail, cls, sound) {
  cls = cls || ''; sound = sound || null;
  var c = document.getElementById('notif-container');
  var d = document.createElement('div');
  d.className = 'notif' + (cls ? ' n' + cls : '');
  d.innerHTML = `<div class="notif-icon">${icon}</div><div class="notif-body"><div class="notif-title">${title}</div><div class="notif-detail">${detail}</div></div><div class="notif-time">${utcNow()}</div>`;
  c.appendChild(d);
  if (c.children.length > 5) c.removeChild(c.children[0]);
  setTimeout(function() { try { c.removeChild(d); } catch(e){} }, 9500);
  if (sound) sound();
}

function showNewsPopup(idx) {
  const item = allNews[idx];
  if (!item) return;
  
  const popup = document.getElementById('news-popup');
  const title = document.getElementById('news-popup-title');
  const source = document.getElementById('news-popup-source');
  const time = document.getElementById('news-popup-time');
  const body = document.getElementById('news-popup-body');
  const link = document.getElementById('news-popup-link');
  
  title.textContent = item.h;
  source.textContent = item.src;
  time.textContent = item.ts || utcNow();
  body.textContent = item.s || 'No additional details available.';
  link.href = getNewsLink(item);
  popup.classList.add('show');
}
function getNewsLink(item) {
  if (item.src === 'Reuters') return 'https://www.reuters.com/world/middle-east/';
  if (item.src === 'BBC') return 'https://www.bbc.com/news/world/middle_east/';
  if (item.src === 'Al Jazeera') return 'https://www.aljazeera.com/';
  return '#';
}
function closeNewsPopup() {
  document.getElementById('news-popup').classList.remove('show');
}
function initNewsPopup() {
  document.getElementById('news-popup').addEventListener('click', function(e) {
    if (e.target === this) {
      closeNewsPopup();
    }
  });
}

function showTab(el, name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function toggleSidebar(side) {
  const sidebar = document.getElementById(side + 'Sidebar');
  sidebar.classList.toggle('collapsed');
}

const map = L.map('map', { zoomControl: false }).setView([28, 56], 5);
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: ' OpenStreetMap CartoDB', maxZoom: 18 }).addTo(map);

const aircraftClusterGroup = L.markerClusterGroup({
  chunkedLoading: true,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  zoomToBoundsOnClick: true
});
aircraftClusterGroup.addTo(map);
const LAYERS = { mil: aircraftClusterGroup, naval: L.layerGroup(), base: L.layerGroup(), range: L.layerGroup() };
const LAYER_ON = { mil: true, naval: true, base: true, range: true };
Object.entries(LAYER_ON).forEach(([k,v]) => { if(v) LAYERS[k].addTo(map); });
function toggleLayer(btn, name) {
  LAYER_ON[name] = !LAYER_ON[name];
  if (LAYER_ON[name]) LAYERS[name].addTo(map);
  else map.removeLayer(LAYERS[name]);
  btn.classList.toggle('active', LAYER_ON[name]);
  if (name === 'range') { LAYERS.range.clearLayers(); if (LAYER_ON.range) addRangeCircles(); }
}
const EMAP = { fighter:'‚úàÔ∏è', tanker:'‚õΩ', cargo:'üì¶', awacs:'üì°', drone:'üõ∏', helicopter:'üöÅ', recon:'üëÅÔ∏è', bomber:'üõ©Ô∏è', stealth:'üëª', transport:'üöå', uav:'üõ∞Ô∏è', maritime:'üö¢' };
const BASES = [
  { lat:25.2, lon:51.6, name:'Al Udeid AB (Qatar)', e:'üá∫üá∏', info:'Largest US base in Middle East. B-52, F-15E, AWACS, JAOC.' },
  { lat:26.2, lon:50.6, name:'NSA Bahrain (5th Fleet)', e:'üá∫üá∏', info:'US 5th Fleet HQ. Command hub for all Gulf naval ops.' },
  { lat:24.4, lon:54.6, name:'Al Dhafra AB (UAE)', e:'üá¶üá™', info:'F-35A, RQ-4 Global Hawk, KC-10. Primary ISR hub.' },
  { lat:7.3, lon:72.4, name:'Diego Garcia', e:'üá¨üáß', info:'B-2 Spirit bombers. 4,800km from Iran. Bunker-buster capable.' },
];
const CARRIERS = [
  { lat:24.1, lon:57.2, name:'USS Abraham Lincoln (CVN-72)', e:'üá∫üá∏', info:'CSG in Gulf of Oman. 60+ F/A-18s. Full combat readiness.' },
];
const TARGETS = [
  { lat:33.7, lon:51.7, name:'Natanz Enrichment', c:'#f44336' },
  { lat:34.9, lon:48.8, name:'Fordow Underground (Qom)', c:'#ff7043' },
];
function buildStaticLayers() {
  BASES.forEach(b => {
    L.marker([b.lat,b.lon],{icon:L.divIcon({html:`<div style="font-size:18px;filter:drop-shadow(0 0 4px rgba(41,182,246,0.9))">${b.e}</div>`,className:'',iconSize:[22,22]})}).addTo(LAYERS.base).bindPopup(`<b>${b.e} ${b.name}</b><br><br>${b.info}`);
  });
  CARRIERS.forEach(c => {
    L.marker([c.lat,c.lon],{icon:L.divIcon({html:`<div class="emoji-marker carrier">${c.e}</div>`,className:'',iconSize:[28,28]})}).addTo(LAYERS.naval).bindPopup(`<b>${c.e} ${c.name}</b><br><small style="color:#f44336">CARRIER STRIKE GROUP</small><br><br>${c.info}`);
  });
}
function addRangeCircles() {
  L.circle([7.3,72.4],{color:'#f44336',fillColor:'#f44336',fillOpacity:0.04,weight:1,dashArray:'8,4',radius:9000000}).addTo(LAYERS.range).bindPopup('B-2 range from Diego Garcia (~11,000km)');
  TARGETS.forEach(t => {
    L.circleMarker([t.lat,t.lon],{color:t.c,fillColor:t.c,fillOpacity:0.7,radius:7,weight:2}).addTo(LAYERS.range).bindPopup(`<b> ${t.name}</b><br><small style="color:#ff7043">POTENTIAL STRIKE TARGET</small>`);
  });
}

var HI_TYPES = { tanker:'KC-135 TANKER', awacs:'AWACS ACTIVATED', stealth:'STEALTH ASSET', bomber:'BOMBER DETECTED' };
function mockAircraft() {
  const types = Object.keys(EMAP);
  return Array.from({length:150},(_,i) => ({
    lat:22+Math.random()*18, lon:44+Math.random()*28,
    type:types[Math.floor(Math.random()*types.length)],
    hex:'MK'+i.toString(16).toUpperCase().padStart(4,'0'),
    gs:Math.floor(Math.random()*500)+100,
    alt:Math.floor(Math.random()*38000)+5000
  }));
}
function checkNewAircraft(newAc) {
  if (firstScan) return;
  newAc.forEach(ac => {
    if (!prevHexes.has(ac.hex) && HI_TYPES[ac.type]) {
      const label = HI_TYPES[ac.type];
      notify(EMAP[ac.type]||'‚úàÔ∏è', label + ' ‚Äî NEW CONTACT',
        `Hex ${ac.hex} ¬∑ ${ac.gs||'?'} kt ¬∑ ${ac.lat.toFixed(2)}¬∞N ${ac.lon.toFixed(2)}¬∞E`,
        'orange', playChime_aircraft);
    }
  });
}
function renderAircraft() {
  aircraftClusterGroup.clearLayers();
  const minSpd = parseInt(document.getElementById('speedFilter').value)||0;
  const markers = [];
  allAircraft
    .filter(ac => (currentFilter==='all'||ac.type===currentFilter) && (ac.gs||0)>=minSpd)
    .forEach(ac => {
      const e = EMAP[ac.type]||'‚úàÔ∏è';
      const big = ac.type==='tanker';
      const marker = L.marker([ac.lat,ac.lon],{
        icon: L.divIcon({html:`<div class="emoji-marker${big?' tanker':''}">${e}</div>`,className:'',iconSize:[big?26:20,big?26:20]})
      });
      marker.bindPopup(`<b>${e} ${(ac.type||'MIL').toUpperCase()}</b> ¬∑ ${ac.hex}<br><small>${ac.gs||'?'} kt</small>`);
      markers.push(marker);
    });
  aircraftClusterGroup.addLayers(markers);
  
  document.getElementById('aircraftCount').textContent = allAircraft.length;
  document.getElementById('tankerCount').textContent = allAircraft.filter(a=>a.type==='tanker').length;
  document.getElementById('awacsCount').textContent = allAircraft.filter(a=>a.type==='awacs').length;
  document.getElementById('stealthCount').textContent = allAircraft.filter(a=>a.type==='stealth').length;
}
function setFilter(btn, type) {
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentFilter = type;
  renderAircraft();
}
document.getElementById('speedFilter').oninput = function() {
  document.getElementById('speedVal').textContent = this.value + ' kt';
  renderAircraft();
};

const ADSB_SOURCES = [
  {name:'ADS-B.lol MIL',url:'https://api.adsb.lol/v2/mil'},
  {name:'OpenSky States',url:'https://opensky-network.org/api/states/all?lamin=22&lamax=41&lomin=44&lomax=73'},
];
async function fetchIntelligence(url) {
    try {
        const proxy = "https://api.allorigins.win/raw?url=";
        const response = await fetch(proxy + encodeURIComponent(url));
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
    } catch (error) {
        console.error("Intelligence Retrieval Failed:", error);
        document.getElementById('ticker').innerText = "‚ö†Ô∏è FEED ERROR: Check CORS/API Connection";
        return null;
    }
}
async function runScan(manual) {
  manual = manual || false;
  if (scanning) return;
  scanning = true;
  const btn = document.getElementById('scanBtn');
  btn.textContent = '‚è≥ Scanning‚Ä¶'; btn.disabled = true;
  document.getElementById('sourceList').innerHTML = '';
  let merged = [];
  for (const src of ADSB_SOURCES) {
    const row = document.createElement('div');
    row.className = 'src-row';
    row.innerHTML = `<span class="src-name">${src.name}</span><span class="src-loading">‚óå</span>`;
    document.getElementById('sourceList').appendChild(row);
    if (src.url) {
        const j = await fetchIntelligence(src.url);
        if(j){
            if (j.ac) merged = merged.concat(j.ac.map(a=>({...a,type:a.t||'fighter'})));
            if (j.states) merged = merged.concat(j.states.filter(s=>s[6]&&s[5]).map(s=>({lat:s[6],lon:s[5],hex:s[0],gs:s[9],type:'fighter'})));
        }
    }
    row.innerHTML = `<span class="src-name">${src.name}</span><span class="src-ok">‚úì ${new Date().toISOString().substr(11,8)}</span>`;
    await new Promise(r=>setTimeout(r,70));
  }
  const mock = mockAircraft();
  const real = merged.filter(a=>a.lat>20&&a.lat<42&&a.lon>42&&a.lon<76);
  const newAc = real.length > 50 ? [...real,...mock.slice(0,30)] : [...real,...mock];
  checkNewAircraft(newAc);
  prevHexes = new Set(newAc.map(a=>a.hex));
  allAircraft = newAc;
  renderAircraft();
  updateRisk();
  if (!firstScan || manual) {
    showMapBanner('Scan complete ‚Äî ' + allAircraft.length + ' assets tracked');
    if (manual) playChime_radar();
  }
  firstScan = false;
  btn.textContent = '‚ö° Manual Scan'; btn.disabled = false;
  scanning = false;
  updateScanStatus();
}
function updateScanStatus() {
  nextScanIn = 180;
  var el = document.getElementById('scan-status');
  clearInterval(scanCountdown);
  scanCountdown = setInterval(function() {
    nextScanIn--;
    el.textContent = 'Next auto-scan in ' + nextScanIn + 's';
    if (nextScanIn <= 0) { clearInterval(scanCountdown); runScan(false); }
  }, 1000);
}

function updateRisk() {
  const pct = Math.min(99, 68 + allAircraft.filter(a=>a.type==='tanker').length*0.4 + Math.random()*4);
  const r = Math.round(pct);
  document.getElementById('risk-num').textContent = r + '%';
  const circ = 2*Math.PI*44;
  document.getElementById('ring-fill').style.strokeDashoffset = circ - (circ*r/100);
}

function showMapBanner(text) {
  const el = document.getElementById('map-banner');
  el.textContent = text; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 7000);
}

const SOURCE_COLORS = { 'Reuters': {bg:'#FF5733',short:'REU'}, 'AP': {bg:'#C70000',short:'AP'}, 'BBC': {bg:'#BB1919',short:'BBC'}, 'CNN': {bg:'#CC0000',short:'CNN'}, 'Fox News':   {bg:'#003087',short:'FOX'}, 'Al Jazeera':{bg:'#8B0000',short:'AJ'}, 'PressTV':    {bg:'#1a7a4a',short:'PTV'}};
function srcStyle(src) {
  const s = SOURCE_COLORS[src] || {bg:'#2d4a22',short:src.substr(0,3).toUpperCase()};
  return `background:${s.bg}`;
}
function srcShort(src) { return (SOURCE_COLORS[src]||{short:src.substr(0,3).toUpperCase()}).short; }
function renderNewsStream() {
  const feed = document.getElementById('news-stream');
  feed.innerHTML = '';
  allNews.slice(0, 80).forEach((item, idx) => {
    const d = document.createElement('div');
    d.className = 'ns-item ' + item.cat + (item.isNew ? ' new-flash' : '');
    d.innerHTML = `
      <div class="ns-source-logo" style="${srcStyle(item.src)}">${srcShort(item.src)}</div>
      <div class="ns-body">
        <div class="ns-meta">
          <span class="ns-source-name">${item.src}</span>
          <span class="ns-time">${item.ts ? new Date(item.ts).toLocaleTimeString() + ' UTC' : utcNow()}</span>
          <span class="ns-cat ${item.cat}">${item.cat}</span>
        </div>
        <div class="ns-headline" onclick="showNewsPopup(${idx})">${item.h}</div>
        ${item.s ? `<div class="ns-summary">${item.s}</div>` : ''}
      </div>
      <div class="ns-tts-btn" data-idx="${idx}" title="Read aloud">üîä</div>`;
    feed.appendChild(d);
  });
  document.getElementById('nc-count').textContent = allNews.length + ' items';
}
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.ns-tts-btn');
  if (!btn) return;
  const idx = parseInt(btn.getAttribute('data-idx'), 10);
  if (!allNews[idx]) return;
  if (!ttsOn) toggleTTS();
  speak(allNews[idx].h, true);
});

var TICKERS = [ '‚ö° ELEVATED THREAT ‚Äî POLYMARKET 67% STRIKE BY JUN 30', 'üçï PIZZA INDEX: +58% ABOVE NORMAL', '‚úàÔ∏è ADS-B: TANKER RACETRACK ORBITS ACTIVE' ];
var tickEl = document.getElementById('ticker');
setInterval(function() {
  tickIdx = (tickIdx+1) % TICKERS.length;
  tickEl.style.opacity = '0';
  setTimeout(function() { tickEl.textContent = TICKERS[tickIdx]; tickEl.style.opacity = '1'; }, 300);
}, 10000);
function updateTickerWithNews(text) {
  tickEl.style.opacity = '0';
  setTimeout(function() { tickEl.textContent = 'üì∞ ' + text; tickEl.style.opacity = '1'; }, 300);
}

var X_ITEMS = [
  {handle:'@PizzINT_Official',time:'14:18',text:'Papa John's 0.5mi from Pentagon: +58% above normal for a Sunday afternoon.'},
  {handle:'@OSINTGuru',time:'13:55',text:'CONFIRMED: Multiple KC-135 tankers in persistent orbit over Gulf of Oman.'},
];
var X_NEW = [ {handle:'@AeroWatch',text:'LIVE: 2 new KC-135 contacts just appeared -- refueling bridge expanding.'} ];
function renderXFeed() {
  document.getElementById('x-feed').innerHTML = X_ITEMS.concat(X_NEW.slice(0, xInserted)).reverse().map(function(x) {
    return `<div class="x-item"><span class="x-handle">${x.handle}</span><span class="x-time">${x.time||utcNow()}</span><div class="x-text">${x.text}</div></div>`;
  }).join('');
}
function injectNewTweet() {
  if (xInserted >= X_NEW.length) xInserted = 0;
  const item = X_NEW[xInserted]; xInserted++;
  item.time = utcNow();
  renderXFeed();
  notify('ùïè', 'NEW OSINT: ' + item.handle, item.text.substr(0, 100) + '‚Ä¶', 'orange', playChime_news);
  if (ttsOn) speak(`New OSINT from ${item.handle}. ${item.text}`);
}

function updatePizza() {
  const pj = Math.round(40+Math.random()*45);
  document.getElementById('pj-pct').textContent='+'+pj+'%';
  document.getElementById('pj-bar').style.width=Math.min(pj,100)+'%';
  const pips=document.querySelectorAll('.pizza-pip');
  const n=pj>80?5:pj>60?4:pj>35?3:pj>15?2:1;
  pips.forEach((p,i)=>{p.classList.remove('on','hot');if(i<n){p.classList.add(n>=5?'hot':'on');}});
}

function showScenario(t) {
  const texts={ limited:'LIMITED STRIKE (54%)

Targets: Natanz + Fordow', major:'MAJOR ESCALATION (23%)

B-2 + Hormuz mines deployed', diplomatic:'DIPLOMATIC DEAL (17%)

Oman talks succeed.', cyber:'CYBER / GRAY ZONE (6%)

Stuxnet 2.0 on centrifuges.' };
  alert(texts[t]);
}
function runMonteCarlo() {
  const el=document.getElementById('mc-result');
  el.textContent='‚è≥ Running 1,000 simulations‚Ä¶';
  setTimeout(()=>{el.textContent='Monte Carlo (n=1,000):

Limited Strike:   54.2%
Major Escalation: 22.8%
Diplomatic Deal:  16.9%
Cyber/Gray Zone:   6.1%';},2000);
}

var DEPART = [ {icon:'‚õΩ',title:'KC-135 TANKER DEPARTURE',detail:'Callsign REACH321 departed Al Udeid.',cls:'red',snd:playChime_aircraft,tts:'New tanker departure.'} ];
function sendDeparture() {
  if (firstScan) return;
  var d = DEPART[deptIdx % DEPART.length]; deptIdx++;
  notify(d.icon, d.title, d.detail, d.cls, d.snd);
  if (ttsOn) speak(d.tts, d.cls==='red');
}

function generateSparkline(points, direction = 'up') {
  const width = 40, height = 12;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width', width); svg.setAttribute('height', height);
  const data = Array.from({length:points}, () => Math.random() * height);
  if (direction === 'up') data.sort((a, b) => a - b); else data.sort((a, b) => b - a);
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  const pathData = data.map((y, i) => (i===0?'M':'L') + ` ${(i/(points-1))*width} ${y}`).join(' ');
  path.setAttribute('d', pathData);
  path.setAttribute('stroke', direction === 'up' ? '#4CAF50' : '#f44336');
  path.setAttribute('stroke-width', '1.5'); path.setAttribute('fill', 'none');
  svg.appendChild(path);
  return svg;
}
function initSparklines() {
  document.querySelectorAll('.sparkline').forEach(el => {
    el.appendChild(generateSparkline(8, el.classList.contains('up') ? 'up' : 'down'));
  });
}

function initTooltips() {
  document.querySelectorAll('.tooltip').forEach(el => {
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip-popup';
    tooltip.textContent = el.getAttribute('data-tooltip');
    document.body.appendChild(tooltip);
    el.addEventListener('mouseenter', (e) => {
      const rect = el.getBoundingClientRect();
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
      tooltip.classList.add('show');
    });
    el.addEventListener('mouseleave', () => tooltip.classList.remove('show'));
  });
}

window.addEventListener('load', () => {
  buildStaticLayers();
  if (LAYER_ON.range) addRangeCircles();
  runScan(false);
  updateScanStatus();
  renderXFeed();
  initSparklines();
  initTooltips();
  initNewsPopup();
  setInterval(injectNewTweet, 120000 + Math.random()*120000);
  setInterval(sendDeparture, 60000 + Math.random()*90000);
  setInterval(updatePizza, 20000);
  setInterval(updateRisk, 30000);
  setTimeout(() => {
    notify('üåç', 'OSINT FUSION ONLINE', 'All systems nominal. Awaiting data feeds.', 'green', playChime_startup);
  }, 1500);
});
</script>
</body>
</html>
