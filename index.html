<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRAN TENSION MONITOR v9.2 â€” LIVE FEED</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
:root {
  --bg: #0f1923; --panel: #162030; --panel-dark: #0d1520;
  --border: #253a52; --text: #d4e6f8; --text-dim: #8899aa; --bright: #ffffff;
  --accent: #29b6f6; --danger: #f44336; --warn: #ffa726; --green: #4caf50;
  --purple: #ab47bc; --pizza: #ff7043;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; background: var(--bg); color: var(--text); }

/* HEADER */
#header {
  height: 42px; background: #0a1218; border-bottom: 2px solid var(--accent);
  display: flex; align-items: center; padding: 0 12px; gap: 10px; flex-shrink: 0; z-index: 300;
}
.logo { font-size: 16px; font-weight: 700; color: #fff; white-space: nowrap; }
.badge { background: #29b6f618; border: 1px solid var(--accent); color: var(--accent); padding: 2px 7px; border-radius: 3px; font-size: 11px; white-space: nowrap; }
#ticker { flex: 1; font-size: 12px; color: var(--warn); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: opacity 0.3s; }
#clock { font-size: 14px; color: var(--accent); font-family: 'Courier New', monospace; white-space: nowrap; }
.live-dot { width: 7px; height: 7px; background: var(--danger); border-radius: 50%; animation: blink 1s infinite; flex-shrink: 0; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
.hdr-btn { cursor: pointer; padding: 3px 9px; border: 1px solid var(--border); border-radius: 3px; font-size: 12px; background: transparent; color: var(--text-dim); white-space: nowrap; transition: all 0.2s; }
.hdr-btn.on { border-color: var(--green); color: var(--green); }
.hdr-btn:hover { border-color: var(--accent); color: var(--accent); }

/* COLLAPSE BUTTONS */
.collapse-btn {
  position: absolute; top: 8px; right: 8px; z-index: 10;
  background: rgba(10,18,24,0.8); border: 1px solid var(--border);
  color: var(--text-dim); padding: 4px 8px; border-radius: 3px; cursor: pointer;
  font-size: 11px; transition: all 0.2s;
}
.collapse-btn:hover { border-color: var(--accent); color: var(--accent); }
.sidebar.collapsed { width: 40px; }
.sidebar-right.collapsed { width: 40px; }
.sidebar.collapsed .section, .sidebar-right.collapsed .tab-pane { display: none; }
.sidebar.collapsed .collapse-btn::after { content: 'â†’'; }
.sidebar-right.collapsed .collapse-btn::after { content: 'â†'; }

/* MAIN LAYOUT */
#main { display: flex; height: calc(100vh - 42px); overflow: hidden; }

/* SIDEBARS */
.sidebar, .sidebar-right {
  background: var(--panel-dark); border-color: var(--border);
  overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; flex-shrink: 0;
  position: relative; transition: width 0.3s ease;
}
.sidebar { width: 270px; border-right: 1px solid var(--border); }
.sidebar-right { width: 340px; border-left: 1px solid var(--border); }

/* CENTER â€” map top half, news bottom half */
#center { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
#map-wrap { height: 50%; position: relative; border-bottom: 2px solid var(--accent); flex-shrink: 0; }
#map { height: 100%; width: 100%; }
#news-center { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: var(--panel-dark); }
#news-center-header {
  height: 36px; background: #0a1218; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 12px; gap: 10px; flex-shrink: 0;
}
#news-center-header .nc-title { font-size: 12px; font-weight: 700; color: var(--accent); }
#news-center-header .nc-sources { font-size: 10px; color: var(--text-dim); flex: 1; }
#news-center-header .nc-count { font-family: 'Courier New', monospace; font-size: 11px; color: var(--green); }
#news-stream { flex: 1; overflow-y: auto; padding: 0; }

/* LIVE NEWS STREAM â€” CENTER PANEL */
.ns-item {
  display: flex; gap: 10px; padding: 8px 12px;
  border-bottom: 1px solid #162030; transition: background 0.2s; cursor: pointer; align-items: flex-start;
}
.ns-item:hover { background: #122035; }
.ns-item.BREAKING { border-left: 3px solid var(--danger); background: #f4433608; }
.ns-item.MILITARY { border-left: 3px solid var(--warn); }
.ns-item.DIPLOMATIC { border-left: 3px solid var(--purple); }
.ns-item.ECONOMIC { border-left: 3px solid var(--green); }
.ns-item.OSINT { border-left: 3px solid var(--pizza); }
.ns-item.new-flash { animation: flashNew 3s ease; }
@keyframes flashNew { 0%{background:#29b6f625}100%{} }
.ns-source-logo {
  width: 36px; height: 36px; border-radius: 4px; display: flex; align-items: center;
  justify-content: center; font-size: 10px; font-weight: 700; color: #fff;
  flex-shrink: 0; text-align: center; line-height: 1.2;
}
.ns-body { flex: 1; min-width: 0; }
.ns-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; flex-wrap: wrap; }
.ns-source-name { font-size: 10px; font-weight: 700; color: var(--text-dim); }
.ns-time { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; }
.ns-cat { font-size: 9px; padding: 1px 5px; border-radius: 2px; font-weight: 700; letter-spacing: 0.5px; }
.ns-cat.BREAKING { background: #f4433625; color: var(--danger); border: 1px solid #f4433650; }
.ns-cat.MILITARY { background: #ffa72620; color: var(--warn); border: 1px solid #ffa72650; }
.ns-cat.DIPLOMATIC { background: #ab47bc20; color: var(--purple); border: 1px solid #ab47bc50; }
.ns-cat.ECONOMIC { background: #4caf5020; color: var(--green); border: 1px solid #4caf5050; }
.ns-cat.OSINT { background: #ff704320; color: var(--pizza); border: 1px solid #ff704350; }
.ns-headline { font-size: 12px; font-weight: 600; color: var(--bright); line-height: 1.4; }
.ns-summary { font-size: 11px; color: var(--text-dim); margin-top: 2px; line-height: 1.3; }
.ns-read { font-size: 10px; color: var(--accent); margin-top: 3px; }
.ns-tts-btn { font-size: 16px; cursor: pointer; opacity: 0.5; flex-shrink: 0; margin-top: 2px; transition: opacity 0.2s; }
.ns-tts-btn:hover { opacity: 1; }

/* SECTIONS */
.section { border-bottom: 1px solid var(--border); padding: 9px 11px; }
.sec-title { font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 7px; display: flex; align-items: center; gap: 6px; }
.sec-title.red { color: var(--danger); }
.sec-title.orange { color: var(--warn); }
.sec-title.green { color: var(--green); }
.sec-title.pizza { color: var(--pizza); }

/* TOOLTIPS */
.tooltip {
  position: relative; cursor: help;
  border-bottom: 1px dotted var(--text-dim);
}
.tooltip::after {
  content: attr(data-tooltip);
  position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
  background: rgba(10,18,24,0.95); color: var(--text);
  padding: 4px 8px; border-radius: 3px; font-size: 11px; white-space: nowrap;
  opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1000;
}
.tooltip:hover::after { opacity: 1; }

/* SPARKLINES */
.sparkline {
  width: 40px; height: 12px; margin-left: 8px;
  background: linear-gradient(to right, 
    transparent 0%, transparent 45%,
    var(--accent) 45%, var(--accent) 55%,
    transparent 55%, transparent 70%,
    var(--warn) 70%, var(--warn) 80%,
    transparent 80%, transparent 100%
  );
  border-radius: 2px; opacity: 0.7;
}
.sparkline.up { background: linear-gradient(to right, var(--green) 0%, var(--green) 100%); }
.sparkline.down { background: linear-gradient(to right, var(--danger) 0%, var(--danger) 100%); }

/* STAT ROW */
.stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #1a2d40; font-size: 13px; }
.stat-row .lbl { color: var(--text-dim); font-weight: 500; }
.stat-row .val { font-family: 'Courier New', monospace; font-weight: 700; }
.stat-row .val.red { color: var(--danger); }
.stat-row .val.orange { color: var(--warn); }
.stat-row .val.green { color: var(--green); }

/* RISK RING */
#risk-wrap { text-align: center; padding: 4px 0 2px; }
#risk-wrap svg { transform: rotate(-90deg); }
#ring-bg { fill: none; stroke: #1e3048; stroke-width: 10; }
#ring-fill { fill: none; stroke-width: 10; stroke-linecap: round; stroke: var(--danger); transition: stroke-dashoffset 1.5s; }
#risk-num { font-size: 26px; font-weight: 700; color: var(--danger); }
#risk-sub { font-size: 10px; color: var(--text-dim); }
.risk-badge { text-align: center; padding: 3px; border-radius: 3px; font-size: 11px; font-weight: 700; margin-bottom: 7px; background: #f4433618; border: 1px solid var(--danger); color: var(--danger); }

/* SIGNAL BARS */
.sig-row { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
.sig-name { font-size: 10px; color: var(--text-dim); width: 88px; flex-shrink: 0; }
.sig-bg { flex: 1; height: 5px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.sig-fill { height: 100%; border-radius: 3px; transition: width 1.5s; }
.sig-val { font-size: 10px; font-family: 'Courier New', monospace; width: 26px; text-align: right; color: var(--text-dim); }

/* FILTERS */
.filter-row { display: flex; flex-wrap: wrap; gap: 4px; margin: 5px 0; }
.filter-btn { background: #0d1a28; border: 1px solid var(--border); color: var(--text-dim); padding: 2px 8px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
.filter-btn.active { background: #29b6f618; border-color: var(--accent); color: var(--accent); }

/* SOURCE LIST */
.src-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #1a2d40; font-size: 10px; }
.src-name { color: var(--text-dim); }
.src-ok { color: var(--green); font-family: 'Courier New', monospace; }
.src-loading { color: var(--warn); }

/* MAP CONTROLS */
#map-controls { position: absolute; top: 8px; left: 8px; z-index: 500; display: flex; flex-direction: column; gap: 4px; }
.map-btn { background: rgba(10,18,24,0.9); border: 1px solid var(--border); color: var(--text); padding: 4px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.map-btn:hover { border-color: var(--accent); color: var(--accent); }
.map-btn.active { background: #29b6f612; border-color: var(--accent); color: var(--accent); }

/* MAP BANNER */
#map-banner { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); z-index: 500; background: rgba(10,18,24,0.95); border: 1px solid var(--warn); border-radius: 4px; padding: 5px 12px; font-size: 11px; color: var(--warn); display: none; white-space: nowrap; }
#map-banner.show { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)} }

/* TABS (right sidebar) */
.tab-bar { display: flex; background: #0a1218; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.tab { flex: 1; padding: 7px 3px; text-align: center; font-size: 10px; font-weight: 700; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); background: #29b6f60c; }
.tab-pane { display: none; overflow-y: auto; padding: 9px 11px; flex: 1; }
.tab-pane.active { display: block; }

/* RIGHT SIDEBAR NEWS (smaller, curated) */
.rn-item { padding: 6px 8px; margin: 4px 0; border-left: 3px solid var(--accent); background: #0d1a28; border-radius: 0 4px 4px 0; font-size: 11px; }
.rn-item.mil { border-left-color: var(--danger); }
.rn-item.dip { border-left-color: var(--purple); }
.rn-item.eco { border-left-color: var(--green); }
.rn-item.osint { border-left-color: var(--pizza); }
.rn-time { font-size: 10px; color: var(--text-dim); margin-bottom: 2px; font-family: 'Courier New', monospace; }
.rn-headline { color: var(--bright); font-weight: 600; line-height: 1.3; }
.rn-why { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-style: italic; }

/* X FEED */
.x-item { padding: 6px 8px; margin: 4px 0; background: #0d1a28; border: 1px solid #1e3048; border-radius: 4px; font-size: 11px; }
.x-handle { color: var(--accent); font-weight: 700; }
.x-time { color: var(--text-dim); font-size: 10px; float: right; font-family: 'Courier New', monospace; }
.x-text { color: var(--text); line-height: 1.4; margin-top: 3px; }

/* PIZZA */
.pizza-bar-row { margin: 4px 0; }
.pbl { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px; }
.pbl .pct { font-family: 'Courier New', monospace; font-weight: 700; color: var(--pizza); }
.pb-bg { height: 7px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.pb-fill { height: 100%; border-radius: 3px; background: var(--pizza); transition: width 2s; }
.pizza-defcon { display: flex; gap: 4px; justify-content: center; margin: 6px 0; }
.pizza-pip { width: 30px; height: 30px; border: 2px solid #1a2d40; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.pizza-pip.on { border-color: var(--pizza); box-shadow: 0 0 8px #ff704330; }
.pizza-pip.hot { border-color: var(--danger); box-shadow: 0 0 12px #f4433660; animation: hotpip 0.8s infinite; }
@keyframes hotpip { 0%,100%{box-shadow:0 0 8px #f4433640}50%{box-shadow:0 0 18px #f44336} }

/* POLYMARKET */
.pm-row { padding: 5px 8px; margin: 3px 0; background: #0d1a28; border: 1px solid var(--border); border-radius: 4px; position: relative; overflow: hidden; }
.pm-bg { position: absolute; left: 0; top: 0; bottom: 0; opacity: 0.1; background: var(--danger); }
.pm-label { font-size: 10px; color: var(--text-dim); margin-bottom: 2px; position: relative; }
.pm-val { font-size: 16px; font-weight: 700; color: var(--danger); font-family: 'Courier New', monospace; position: relative; }
.pm-vol { font-size: 10px; color: var(--text-dim); position: relative; }
.pm-row.warn .pm-bg { background: var(--warn); }
.pm-row.warn .pm-val { color: var(--warn); }

/* KRI */
.kri-row { display: flex; align-items: center; gap: 7px; padding: 4px 0; border-bottom: 1px solid #1a2d40; }
.kri-icon { font-size: 15px; width: 22px; text-align: center; flex-shrink: 0; }
.kri-body { flex: 1; }
.kri-lbl { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-bottom: 2px; }
.kri-status.red { color: var(--danger); font-weight: 700; }
.kri-status.orange { color: var(--warn); font-weight: 700; }
.kri-status.green { color: var(--green); font-weight: 700; }
.kri-bar-bg { height: 4px; background: #1a2d40; border-radius: 3px; overflow: hidden; }
.kri-bar-fill { height: 100%; border-radius: 3px; }
.kri-bar-fill.red { background: var(--danger); }
.kri-bar-fill.orange { background: var(--warn); }
.kri-bar-fill.green { background: var(--green); }
.kri-bar-fill.crit { background: var(--danger); animation: cpulse 1s infinite; }
@keyframes cpulse { 0%,100%{opacity:0.8}50%{opacity:1} }

/* SCENARIO */
.sc-card { padding: 7px 9px; margin: 4px 0; background: #0d1a28; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; transition: border-color 0.2s; }
.sc-card:hover { border-color: var(--accent); }
.sc-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.sc-title { font-weight: 700; font-size: 12px; }
.sc-prob { font-size: 15px; font-weight: 700; font-family: 'Courier New', monospace; }
.sc-prob.red { color: var(--danger); }
.sc-prob.green { color: var(--green); }
.sc-prob.orange { color: var(--warn); }
.sc-desc { font-size: 10px; color: var(--text-dim); line-height: 1.4; }
#mc-result { font-size: 10px; margin-top: 7px; font-family: 'Courier New', monospace; color: var(--text-dim); white-space: pre; }

/* NOTIFICATIONS */
#notif-container { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 9000; display: flex; flex-direction: column-reverse; gap: 5px; pointer-events: none; max-width: 560px; width: 95%; }
.notif { background: #0d1a28; border: 1px solid var(--accent); border-left: 4px solid var(--accent); border-radius: 4px; padding: 7px 11px; font-size: 11px; animation: slideUp 0.3s ease, fadeOut 0.5s ease 8.5s forwards; pointer-events: all; display: flex; align-items: flex-start; gap: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
.notif.nred { border-color: var(--danger); border-left-color: var(--danger); }
.notif.norange { border-color: var(--warn); border-left-color: var(--warn); }
.notif.ngreen { border-color: var(--green); border-left-color: var(--green); }
.notif.npizza { border-color: var(--pizza); border-left-color: var(--pizza); }
.notif-icon { font-size: 18px; flex-shrink: 0; }
.notif-body { flex: 1; }
.notif-title { font-weight: 700; color: #fff; margin-bottom: 2px; font-size: 12px; }
.notif-detail { color: var(--text-dim); line-height: 1.3; }
.notif-time { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; white-space: nowrap; flex-shrink: 0; }
@keyframes slideUp { from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1} }
@keyframes fadeOut { from{opacity:1;pointer-events:all}to{opacity:0;pointer-events:none} }

/* TTS INDICATOR */
#tts-indicator { position: fixed; top: 50px; right: 12px; background: #0d1a28; border: 1px solid var(--green); border-radius: 4px; padding: 4px 10px; font-size: 11px; color: var(--green); z-index: 9001; display: none; }
#tts-indicator.show { display: flex; align-items: center; gap: 6px; }
.tts-wave { display: flex; gap: 2px; align-items: center; }
.tts-bar { width: 3px; border-radius: 2px; background: var(--green); animation: wave 0.8s ease-in-out infinite; }
.tts-bar:nth-child(2) { animation-delay: 0.1s; }
.tts-bar:nth-child(3) { animation-delay: 0.2s; }
.tts-bar:nth-child(4) { animation-delay: 0.15s; }
@keyframes wave { 0%,100%{height:4px}50%{height:14px} }

/* BOTTOM TICKER */
#bottom-bar { height: 30px; background: #0a1218; border-top: 1px solid var(--border); display: flex; align-items: center; overflow: hidden; flex-shrink: 0; }
.tick { white-space: nowrap; padding: 0 12px; font-size: 10px; font-family: 'Courier New', monospace; color: var(--text-dim); border-right: 1px solid var(--border); flex-shrink: 0; }
.tick .up { color: var(--green); }
.tick .dn { color: var(--danger); }
.tick .wn { color: var(--warn); }

/* BUTTONS */
.btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 5px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; width: 100%; margin-top: 5px; font-family: 'Segoe UI', Arial, sans-serif; transition: all 0.2s; }
.btn:hover { background: var(--accent); color: #0d1520; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* SCAN STATUS */
#scan-status { font-size: 10px; color: var(--text-dim); font-family: 'Courier New', monospace; margin-top: 4px; text-align: center; }

/* MAP */
.leaflet-container { background: #0d1a28 !important; }
.emoji-marker { font-size: 18px; line-height: 1; filter: drop-shadow(0 0 3px rgba(41,182,246,0.6)); }
.emoji-marker.tanker { font-size: 24px; filter: drop-shadow(0 0 5px rgba(255,112,67,0.9)); }
.emoji-marker.carrier { font-size: 26px; filter: drop-shadow(0 0 7px rgba(244,67,54,0.9)); }
.leaflet-popup-content-wrapper { background: #162030; border: 1px solid var(--border); color: var(--text); border-radius: 5px; font-size: 13px; }
.leaflet-popup-tip { background: #162030; }

/* MARKER CLUSTERING */
.marker-cluster-small { background-color: rgba(41, 182, 246, 0.6); }
.marker-cluster-medium { background-color: rgba(41, 182, 246, 0.8); }
.marker-cluster-large { background-color: rgba(41, 182, 246, 1.0); }
.marker-cluster {
  background-clip: padding-box;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  text-align: center;
  font-family: 'Courier New', monospace;
}
.marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: 12px bold; }
.marker-cluster span { line-height: 30px; }

/* NATO SYMBOLS */
.nato-icon {
  width: 20px; height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 12px;
  color: white;
  border-radius: 50%;
}
.nato-fighter { background: #4CAF50; }
.nato-tanker { background: #FF9800; }
.nato-awacs { background: #2196F3; }
.nato-stealth { background: #9C27B0; }
.nato-bomber { background: #F44336; }

/* NEWS COUNT BADGE */
.new-badge { display: inline-block; background: var(--danger); color: #fff; font-size: 9px; font-weight: 700; padding: 1px 5px; border-radius: 10px; margin-left: 4px; vertical-align: middle; }

/* NEWS POPUP MODAL */
#news-popup {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.8); z-index: 10000;
  display: none; align-items: center; justify-content: center;
}
#news-popup.show { display: flex; }
#news-popup-content {
  background: var(--panel); border: 2px solid var(--accent);
  border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80vh;
  overflow-y: auto; position: relative;
}
#news-popup-close {
  position: absolute; top: 10px; right: 10px;
  background: var(--danger); color: white;
  border: none;
  border-radius: 50%; width: 30px; height: 30px;
  font-size: 16px; cursor: pointer; font-weight: bold;
}
#news-popup-close:hover { background: #d32f2f; }
#news-popup-title {
  font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 10px; line-height: 1.3; }
#news-popup-meta {
  font-size: 12px; color: var(--text-dim); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
#news-popup-source { font-weight: 700; color: var(--accent); }
#news-popup-time { font-family: 'Courier New', monospace; }
#news-popup-body {
  font-size: 16px; line-height: 1.5; color: var(--text); margin-bottom: 15px; }
#news-popup-link {
  display: inline-block; background: var(--accent); color: var(--bg); padding: 8px 16px; border-radius: 4px; text-decoration: none; font-weight: 600; font-size: 14px; margin-top: 10px; }
#news-popup-link:hover { background: #1e88e5; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: #0a1218; }
::-webkit-scrollbar-thumb { background: #253a52; border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

input[type=range] { width: 100%; accent-color: var(--accent); margin: 3px 0; }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">ğŸŒ IRAN TENSION MONITOR</div>
  <div class="badge">v9.2 LIVE</div>
  <div class="live-dot"></div>
  <div id="ticker">âš¡ SCANNING LIVE SOURCESâ€¦</div>
  <button class="hdr-btn" id="sound-btn" onclick="toggleSound()">ğŸ”‡ Sound</button>
  <button class="hdr-btn" id="tts-btn" onclick="toggleTTS()">ğŸ”• TTS</button>
  <div id="clock">UTC 00:00:00</div>
</div>

<!-- TTS INDICATOR -->
<div id="tts-indicator">
  <span>ğŸ”Š Reading aloud</span>
</div>

<div id="main">

<!-- LEFT SIDEBAR -->
<div class="sidebar" id="leftSidebar">
  <button class="collapse-btn" onclick="toggleSidebar('left')" title="Toggle sidebar">â—€</button>

  <!-- RISK -->
  <div class="section">
    <div class="sec-title red">Risk Index</div>
    <div id="risk-wrap">
      <svg width="110" height="110" viewBox="0 0 110 110">
        <circle id="ring-bg" cx="55" cy="55" r="44"/>
        <circle id="ring-fill" cx="55" cy="55" r="44" stroke-dasharray="276.5" stroke-dashoffset="72"/>
      </svg>
      <div style="margin-top:-65px;margin-bottom:34px">
        <div id="risk-num">74%</div>
        <div id="risk-sub">Threat Level</div>
      </div>
    </div>
    <div class="risk-badge">âš  ELEVATED â€” IMMINENT WATCH</div>
    <div class="sig-row"><span class="sig-name">ADS-B Density</span><div class="sig-bg"><div class="sig-fill" style="width:82%;background:var(--danger)"></div></div><span class="sig-val" style="color:var(--danger)">82</span></div>
    <div class="sig-row"><span class="sig-name">Pred. Markets</span><div class="sig-bg"><div class="sig-fill" style="width:67%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">67</span></div>
    <div class="sig-row"><span class="sig-name">Pizza Index</span><div class="sig-bg"><div class="sig-fill" style="width:58%;background:var(--pizza)"></div></div><span class="sig-val" style="color:var(--pizza)">58</span></div>
    <div class="sig-row"><span class="sig-name">Oil / CDS</span><div class="sig-bg"><div class="sig-fill" style="width:75%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">75</span></div>
    <div class="sig-row"><span class="sig-name">Naval Posture</span><div class="sig-bg"><div class="sig-fill" style="width:91%;background:var(--danger)"></div></div><span class="sig-val" style="color:var(--danger)">91</span></div>
    <div class="sig-row"><span class="sig-name">Diplomatic</span><div class="sig-bg"><div class="sig-fill" style="width:45%;background:var(--warn)"></div></div><span class="sig-val" style="color:var(--warn)">45</span></div>
  </div>

  <!-- ASSETS -->
  <div class="section">
    <div class="sec-title">Live Asset Count</div>
    <div class="stat-row"><span class="lbl">âœˆï¸ Military Aircraft</span><span class="val red" id="aircraftCount">â€”</span></div>
    <div class="stat-row"><span class="lbl">â›½ Tankers (orbiting)</span><span class="val orange" id="tankerCount">â€”</span></div>
    <div class="stat-row"><span class="lbl">ğŸ“¡ AWACS / Recon</span><span class="val orange" id="awacsCount">â€”</span></div>
    <div class="stat-row"><span class="lbl">ğŸ‘» Stealth Assets</span><span class="val red" id="stealthCount">â€”</span></div>
    <div class="stat-row"><span class="lbl">âš“ US Carriers (Gulf)</span><span class="val red">2</span></div>
    <div class="stat-row"><span class="lbl">ğŸš¢ Warships in Gulf</span><span class="val red">41</span></div>
    <div class="stat-row"><span class="lbl">ğŸš« AIS-Dark Vessels</span><span class="val red">8</span></div>
    <div class="stat-row"><span class="lbl">ğŸ›°ï¸ Space Assets</span><span class="val">11</span></div>
    <div style="margin-top:8px">
      <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px">Speed Filter</div>
      <input type="range" min="0" max="600" value="0" id="speedFilter">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim)"><span>0</span><span id="speedVal" style="color:var(--accent)">0 kt</span><span>600</span></div>
    </div>
    <div class="filter-row">
      <div class="filter-btn active" onclick="setFilter(this,'all')">All</div>
      <div class="filter-btn" onclick="setFilter(this,'tanker')">â›½</div>
      <div class="filter-btn" onclick="setFilter(this,'awacs')">ğŸ“¡</div>
      <div class="filter-btn" onclick="setFilter(this,'stealth')">ğŸ‘»</div>
      <div class="filter-btn" onclick="setFilter(this,'drone')">ğŸ›¸</div>
      <div class="filter-btn" onclick="setFilter(this,'bomber')">ğŸ›©ï¸</div>
    </div>
    <button class="btn" id="scanBtn" onclick="runScan(true)">âš¡ Manual Scan</button>
    <div id="scan-status">Auto-scan every 3 min</div>
    <div id="sourceList" style="margin-top:6px;max-height:200px;overflow-y:auto"></div>
  </div>

  <!-- MARKETS -->
  <div class="section">
    <div class="sec-title orange">Markets</div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Credit Default Swap - insurance against default">ğŸ›¢ï¸ Brent Crude</span><span class="val red">$97.40 +12.3%<div class="sparkline down"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Credit Default Swap - insurance against default">Iran CDS</span><span class="val red">2,840 bps<div class="sparkline up"></div></span></div>
    <div class="stat-row"><span class="lbl">ğŸ’° Gold</span><span class="val orange">$3,218 â–²<div class="sparkline up"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Volatility Index - market fear gauge">âš¡ VIX</span><span class="val red">34.2<div class="sparkline down"></div></span></div>
    <div class="stat-row"><span class="lbl tooltip" data-tooltip="Lockheed Martin stock">ğŸ¦ LMT</span><span class="val green">$628 +28%YTD<div class="sparkline up"></div></span></div>
  </div>

</div>

<!-- CENTER -->
<div id="center">
  <!-- MAP (top half) -->
  <div id="map-wrap">
    <div id="map"></div>
    <div id="map-controls">
      <button class="map-btn active" onclick="toggleLayer(this,'mil')">âœˆï¸ Aircraft</button>
      <button class="map-btn active" onclick="toggleLayer(this,'naval')">ğŸš¢ Naval</button>
      <button class="map-btn active" onclick="toggleLayer(this,'base')">ğŸ  Bases</button>
      <button class="map-btn active" onclick="toggleLayer(this,'range')">ğŸ¯ Ranges</button>
    </div>
    <div id="map-banner"></div>
  </div>

  <!-- NEWS STREAM (bottom half) -->
  <div id="news-center">
    <div id="news-center-header">
      <div class="nc-title">ğŸ“¡ LIVE IRAN NEWS STREAM</div>
      <div class="nc-sources">Reuters Â· AP Â· BBC Â· CNN Â· Fox Â· Al Jazeera Â· DW Â· PressTV Â· RT Â· Times of Israel Â· Haaretz Â· Guardian Â· CBS Â· NBC Â· WSJ Â· MEE Â· Al Arabiya + more</div>
      <div id="nc-count" class="nc-count">0 items</div>
    </div>
    <div id="news-stream"></div>
  </div>

  <!-- BOTTOM TICKER -->
  <div id="bottom-bar">
    <div class="tick">ğŸ›¢ï¸ BRENT <span class="tooltip" data-tooltip="Credit Default Swap - insurance against default"><span class="dn">$97.40</span><div class="sparkline down"></div></span></div>
    <div class="tick">IRAN CDS <span class="tooltip" data-tooltip="Credit Default Swap - insurance against default"><span class="dn">2,840bps</span><div class="sparkline up"></div></span></div>
    <div class="tick">VIX <span class="tooltip" data-tooltip="Volatility Index - market fear gauge"><span class="dn">34.2</span><div class="sparkline down"></div></span></div>
    <div class="tick">LMT <span class="tooltip" data-tooltip="Lockheed Martin stock"><span class="up">+28%YTD</span><div class="sparkline up"></div></span></div>
    <div class="tick">TRUMP DEADLINE <span class="wn">6 DAYS</span></div>
    <div class="tick">POLYMARKET BY JUN30 <span class="dn">67%</span></div>
    <div class="tick">KALSHI <span class="wn">$87M VOL</span></div>
    <div class="tick">TANKER ORBITS <span class="dn">ACTIVE</span></div>
  </div>
</div>

<!-- RIGHT SIDEBAR -->
<div class="sidebar-right" id="rightSidebar">
  <button class="collapse-btn" onclick="toggleSidebar('right')" title="Toggle sidebar">â–¶</button>
  <div class="tab-bar">
    <div class="tab active" onclick="showTab(this,'osint')">ğ• OSINT</div>
    <div class="tab" onclick="showTab(this,'poly')">ğŸ“Š Poly</div>
    <div class="tab" onclick="showTab(this,'pizza')">ğŸ• Pizza</div>
    <div class="tab" onclick="showTab(this,'kri')">ğŸ¯ KRI</div>
    <div class="tab" onclick="showTab(this,'scenario')">ğŸ² Scenarios</div>
  </div>

  <!-- OSINT -->
  <div class="tab-pane active" id="tab-osint">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Live OSINT â€” unverified, cross-reference</div>
    <div id="x-feed"></div>
  </div>

  <!-- POLYMARKET -->
  <div class="tab-pane" id="tab-poly">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Real-money prediction markets Â· $207M+ total</div>
    <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:5px">US Strikes Iran byâ€¦</div>
    <div class="pm-row"><div class="pm-bg" style="width:25%"></div><div class="pm-label">Feb 28, 2026</div><div class="pm-val">25%</div><div class="pm-vol">$11.2M volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:44%"></div><div class="pm-label">Mar 31, 2026</div><div class="pm-val">44%</div><div class="pm-vol">$7.4M volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:67%"></div><div class="pm-label">Jun 30, 2026 â† frontrunner</div><div class="pm-val">67%</div><div class="pm-vol">$207M total volume</div></div>
    <div class="pm-row"><div class="pm-bg" style="width:73%"></div><div class="pm-label">Dec 31, 2026</div><div class="pm-val">73%</div><div class="pm-vol">Year-end cumulative</div></div>
    <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin:8px 0 5px">Iran Strikes US byâ€¦</div>
    <div class="pm-row warn"><div class="pm-bg" style="width:16%"></div><div class="pm-label">Feb 28, 2026</div><div class="pm-val">16%</div><div class="pm-vol">$157K volume</div></div>
    <div class="pm-row warn"><div class="pm-bg" style="width:33%"></div><div class="pm-label">Mar 31, 2026</div><div class="pm-val">33%</div><div class="pm-vol">$39.5M volume</div></div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:7px">Kalshi (regulated): $87M Iran conflict volume</div>
  </div>

  <!-- PIZZA -->
  <div class="tab-pane" id="tab-pizza">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px;line-height:1.4">Google Maps "Popular Times" at 6 Arlington pizzerias within 2.5mi of Pentagon. Surge >400% historically precedes major ops.</div>
    <div style="font-size:11px;font-weight:700;margin-bottom:5px">DEFCON</div>
    <div class="pizza-defcon" id="pizza-defcon">
      <div class="pizza-pip on">ğŸ•</div><div class="pizza-pip on">ğŸ•</div><div class="pizza-pip on">ğŸ•</div><div class="pizza-pip">ğŸ•</div><div class="pizza-pip">ğŸ•</div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);margin-bottom:8px"><span>Normal</span><span style="color:var(--pizza)">Elevated</span><span style="color:var(--danger)">Crisis</span></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Papa John's (0.5mi)</span><span class="pct" id="pj-pct">+58%</span></div><div class="pb-bg"><div class="pb-fill" id="pj-bar" style="width:58%"></div></div></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Domino's (1.2mi)</span><span class="pct" id="dom-pct">+34%</span></div><div class="pb-bg"><div class="pb-fill" id="dom-bar" style="width:34%"></div></div></div>
    <div class="pizza-bar-row"><div class="pbl"><span>Extreme Pizza (2.5mi)</span><span class="pct" id="ep-pct">+12%</span></div><div class="pb-bg"><div class="pb-fill" id="ep-bar" style="width:12%;background:var(--green)"></div></div></div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:8px;line-height:1.4">Historical: Gulf War +2,000% âœ“ Â· Op. Neptune Spear surge âœ“ Â· Iran drones Apr 2024 âœ“ Â· Israel strikes Iran Jun 2025 âœ“ Â· Venezuela Jan 2026 +400% âœ“ Â· Jan 5 2026 +1,250% âš  pending</div>
    <div style="margin-top:6px"><a href="https://www.pizzint.watch" target="_blank" style="font-size:10px;color:var(--accent)">â†’ pizzint.watch</a></div>
  </div>

  <!-- KRI -->
  <div class="tab-pane" id="tab-kri">
    <div class="kri-row"><div class="kri-icon">âš“</div><div class="kri-body"><div class="kri-lbl"><span>Carrier Strike Groups</span><span class="kri-status red">2/2 DEPLOYED</span></div><div class="kri-bar-bg"><div class="kri-bar-fill crit" style="width:100%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">â›½</div><div class="kri-body"><div class="kri-lbl"><span>Tanker Orbits</span><span class="kri-status red">PERSISTENT</span></div><div class="kri-bar-bg"><div class="kri-bar-fill red" style="width:87%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸ›¢ï¸</div><div class="kri-body"><div class="kri-lbl"><span>Oil Spike</span><span class="kri-status orange">+12.3%</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:75%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸ“¡</div><div class="kri-body"><div class="kri-lbl"><span>AWACS Presence</span><span class="kri-status orange">ELEVATED</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:80%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸš«</div><div class="kri-body"><div class="kri-lbl"><span>AIS-Dark Vessels</span><span class="kri-status red">8 SHIPS</span></div><div class="kri-bar-bg"><div class="kri-bar-fill crit" style="width:92%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸ’¬</div><div class="kri-body"><div class="kri-lbl"><span>Diplomatic Channels</span><span class="kri-status orange">OMAN TALKS</span></div><div class="kri-bar-bg"><div class="kri-bar-fill orange" style="width:45%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸ›°ï¸</div><div class="kri-body"><div class="kri-lbl"><span>Satellite Tasking</span><span class="kri-status red">HIGH PRI</span></div><div class="kri-bar-bg"><div class="kri-bar-fill red" style="width:83%"></div></div></div></div>
    <div class="kri-row"><div class="kri-icon">ğŸŒ</div><div class="kri-body"><div class="kri-lbl"><span>Iran Internet</span><span class="kri-status green">NOMINAL</span></div><div class="kri-bar-bg"><div class="kri-bar-fill green" style="width:20%"></div></div></div></div>
  </div>

  <!-- SCENARIOS -->
  <div class="tab-pane" id="tab-scenario">
    <div style="font-size:10px;color:var(--text-dim);margin-bottom:7px">Monte Carlo Â· 1,000 runs Â· based on live KRI</div>
    <div class="sc-card" onclick="showScenario('limited')"><div class="sc-hdr"><span class="sc-title">ğŸ¯ Limited Strike</span><span class="sc-prob red">54%</span></div><div class="sc-desc">B-2 + Tomahawks on Natanz/Fordow. 36-72hr window. Similar to Jun 2025.</div></div>
    <div class="sc-card" onclick="showScenario('major')"><div class="sc-hdr"><span class="sc-title">ğŸ’¥ Major Escalation</span><span class="sc-prob red">23%</span></div><div class="sc-desc">Multi-site strikes + Iran proxy retaliation. Hormuz threatened.</div></div>
    <div class="sc-card" onclick="showScenario('diplomatic')"><div class="sc-hdr"><span class="sc-title">ğŸ•Šï¸ Diplomatic Deal</span><span class="sc-prob green">17%</span></div><div class="sc-desc">Oman talks succeed. Enrichment freeze. Carriers withdraw.</div></div>
    <div class="sc-card" onclick="showScenario('cyber')"><div class="sc-hdr"><span class="sc-title">ğŸŒ«ï¸ Cyber / Gray Zone</span><span class="sc-prob orange">6%</span></div><div class="sc-desc">Stuxnet 2.0 on centrifuges. No kinetic strike.</div></div>
    <button class="btn" onclick="runMonteCarlo()">âš¡ Run Monte Carlo</button>
    <div id="mc-result"></div>
  </div>
</div>
</div>

<div id="notif-container"></div>

<!-- NEWS POPUP MODAL -->
<div id="news-popup">
  <div id="news-popup-content">
    <button id="news-popup-close" onclick="closeNewsPopup()">Ã—</button>
    <div id="news-popup-title"></div>
    <div id="news-popup-meta">
      <span id="news-popup-source"></span>
      <span id="news-popup-time"></span>
    </div>
    <div id="news-popup-body"></div>
    <a id="news-popup-link" href="#" target="_blank">Read Full Story â†’</a>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var soundOn = false;
var ttsOn = false;
var audioCtx = null;
var firstScan = true;
var allNews = [];
var allAircraft = [];
var prevHexes = new Set();
var currentFilter = 'all';
var scanning = false;
var scanCountdown = null;
var nextScanIn = 180;
var injIdx = 0;
var deptIdx = 0;
var xInserted = 0;
var ttsQueue = [];
var ttsSpeaking = false;
var tickIdx = 0;

function utcNow() { return new Date().toISOString().substr(11,8) + ' UTC'; }
function updateClock() { document.getElementById('clock').textContent = 'UTC ' + new Date().toISOString().substr(11,8); }
setInterval(updateClock, 1000); updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEB SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ws = new WebSocket(`ws://${window.location.host}`);

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.type === 'NEWS_UPDATE') {
        const newItems = data.payload.filter(item => !allNews.some(existing => existing.h === item.h));
        allNews = data.payload;
        if (!firstScan) {
            newItems.slice(0, 3).forEach(item => {
                const isBig = item.cat === 'BREAKING' || item.cat === 'MILITARY';
                notify(
                    item.cat==='BREAKING'?'ğŸš¨':item.cat==='MILITARY'?'âœˆï¸':item.cat==='DIPLOMATIC'?'ğŸ•Šï¸':'ğŸ“°',
                    `[${item.src}] ${item.cat}`,
                    item.h.substr(0, 100) + (item.h.length > 100 ? 'â€¦' : ''),
                    isBig ? 'red' : 'orange',
                    isBig ? playChime_breaking : playChime_news
                );
                if (ttsOn) {
                    if (isBig) speak(`Breaking news from ${item.src}. ${item.h}`, true);
                    else speak(`Update from ${item.src}. ${item.h}`);
                }
            });
            if (newItems.length > 0) {
                const t = newItems[0];
                updateTickerWithNews(t.src + ': ' + t.h.substr(0, 80) + 'â€¦');
            }
        }
        renderNewsStream();
        firstScan = false;
    }
};

ws.onopen = function() {
    console.log('WebSocket connection established');
};

ws.onerror = function(error) {
    console.error('WebSocket Error: ' + error);
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSound() {
  soundOn = !soundOn;
  if (soundOn && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  var b = document.getElementById('sound-btn');
  b.textContent = soundOn ? 'ğŸ”Š Sound' : 'ğŸ”‡ Sound';
  b.className = 'hdr-btn' + (soundOn ? ' on' : '');
}

function toggleTTS() {
  ttsOn = !ttsOn;
  var b = document.getElementById('tts-btn');
  b.textContent = ttsOn ? 'ğŸ”Š TTS' : 'ğŸ”• TTS';
  b.className = 'hdr-btn' + (ttsOn ? ' on' : '');
  if (!ttsOn && window.speechSynthesis) window.speechSynthesis.cancel();
}

// Tone generator
function tone(freq, dur, vol = 0.25, shape = 'sine') {
  if (!soundOn || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = shape;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
  } catch(e){}
}

function playChime_news() {
  // Soft two-tone news ding
  tone(880, 0.12, 0.2);
  setTimeout(() => tone(1100, 0.18, 0.2), 130);
}

function playChime_aircraft() {
  // Rising three-tone alert
  tone(440, 0.1, 0.18, 'square');
  setTimeout(() => tone(550, 0.1, 0.18, 'square'), 110);
  setTimeout(() => tone(660, 0.2, 0.22, 'square'), 220);
}

function playChime_breaking() {
  // Urgent alarm pattern
  for (let i = 0; i < 3; i++) {
    setTimeout(() => { tone(880, 0.08, 0.3, 'sawtooth'); }, i * 200);
    setTimeout(() => { tone(660, 0.08, 0.25, 'sawtooth'); }, i * 200 + 100);
  }
}

function playChime_radar() {
  // Short radar ping
  tone(1200, 0.06, 0.15);
  setTimeout(() => tone(1200, 0.04, 0.08), 300);
}

function playChime_startup() {
  tone(440, 0.1, 0.2);
  setTimeout(() => tone(554, 0.1, 0.2), 120);
  setTimeout(() => tone(660, 0.1, 0.2), 240);
  setTimeout(() => tone(880, 0.25, 0.25), 360);
}

// TTS â€” ttsQueue and ttsSpeaking declared as globals at top
function speak(text, priority) {
  priority = priority || false;
  if (!ttsOn || !window.speechSynthesis) return;
  if (priority) ttsQueue.unshift(text);
  else ttsQueue.push(text);
  if (!ttsSpeaking) flushTTS();
}

function flushTTS() {
  if (!ttsQueue.length || !window.speechSynthesis) { ttsSpeaking = false; document.getElementById('tts-indicator').classList.remove('show'); return; }
  ttsSpeaking = true;
  document.getElementById('tts-indicator').classList.add('show');
  var text = ttsQueue.shift();
  var u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05; u.pitch = 1; u.volume = 1;
  u.onend = function() { flushTTS(); };
  u.onerror = function() { ttsSpeaking = false; document.getElementById('tts-indicator').classList.remove('show'); };
  window.speechSynthesis.speak(u);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function notify(icon, title, detail, cls, sound) {
  cls = cls || ''; sound = sound || null;
  var c = document.getElementById('notif-container');
  var d = document.createElement('div');
  d.className = 'notif' + (cls ? ' n' + cls : '');
  d.innerHTML = '<div class="notif-icon">' + icon + '</div><div class="notif-body"><div class="notif-title">' + title + '</div><div class="notif-detail">' + detail + '</div></div><div class="notif-time">' + utcNow() + '</div>';
  c.appendChild(d);
  if (c.children.length > 5) c.removeChild(c.children[0]);
  setTimeout(function() { try { c.removeChild(d); } catch(e){} }, 9500);
  if (sound) sound();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEWS POPUP FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNewsPopup(idx) {
  const item = allNews[idx];
  if (!item) return;
  
  const popup = document.getElementById('news-popup');
  const title = document.getElementById('news-popup-title');
  const source = document.getElementById('news-popup-source');
  const time = document.getElementById('news-popup-time');
  const body = document.getElementById('news-popup-body');
  const link = document.getElementById('news-popup-link');
  
  title.textContent = item.h;
  source.textContent = item.src;
  time.textContent = item.ts || utcNow();
  body.textContent = item.s || 'No additional details available.';
  
  // Set link based on source
  link.href = getNewsLink(item);
  
  popup.classList.add('show');
}

function getNewsLink(item) {
  // Return appropriate link based on news source
  if (item.src === 'Reuters') {
    return 'https://www.reuters.com/world/middle-east/';
  } else if (item.src === 'BBC') {
    return 'https://www.bbc.com/news/world/middle_east/';
  } else if (item.src === 'Al Jazeera') {
    return 'https://www.aljazeera.com/';
  } else if (item.src === 'AP') {
    return 'https://apnews.com/';
  } else if (item.src === 'CNN') {
    return 'https://www.cnn.com/';
  } else if (item.src === 'Guardian') {
    return 'https://www.theguardian.com/world/iran';
  } else if (item.src === 'Times of Israel') {
    return 'https://www.timesofisrael.com/';
  } else {
    return '#'; // Fallback for unknown sources
  }
}

function closeNewsPopup() {
  const popup = document.getElementById('news-popup');
  popup.classList.remove('show');
}

// Close popup when clicking outside
function initNewsPopup() {
  document.getElementById('news-popup').addEventListener('click', function(e) {
    if (e.target === this) {
      closeNewsPopup();
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(el, name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR TOGGLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(side) {
  const sidebar = document.getElementById(side + 'Sidebar');
  sidebar.classList.toggle('collapsed');
  // Adjust center panel width
  const center = document.getElementById('center');
  if (sidebar.classList.contains('collapsed')) {
    center.style.marginLeft = side === 'left' ? '40px' : '0';
    center.style.marginRight = side === 'right' ? '40px' : '0';
  } else {
    center.style.marginLeft = '0';
    center.style.marginRight = '0';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', { zoomControl: false }).setView([28, 56], 5);
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: ' OpenStreetMap  CartoDB', maxZoom: 18 }).addTo(map);

// Initialize marker clustering
const aircraftClusterGroup = L.markerClusterGroup({
  chunkedLoading: true,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  zoomToBoundsOnClick: true
});
aircraftClusterGroup.addTo(map);

const LAYERS = { mil: aircraftClusterGroup, naval: L.layerGroup(), base: L.layerGroup(), range: L.layerGroup() };
const LAYER_ON = { mil: true, naval: true, base: true, range: true };
Object.entries(LAYER_ON).forEach(([k,v]) => { if(v) LAYERS[k].addTo(map); });

function toggleLayer(btn, name) {
  LAYER_ON[name] = !LAYER_ON[name];
  if (LAYER_ON[name]) LAYERS[name].addTo(map);
  else map.removeLayer(LAYERS[name]);
  btn.classList.toggle('active', LAYER_ON[name]);
  if (name === 'range') { LAYERS.range.clearLayers(); if (LAYER_ON.range) addRangeCircles(); }
}

const EMAP = { fighter:'âœˆï¸', tanker:'â›½', cargo:'ğŸ“¦', awacs:'ğŸ“¡', drone:'ğŸ›¸', helicopter:'ğŸš', recon:'ğŸ‘ï¸', bomber:'ğŸ›©ï¸', stealth:'ğŸ‘»', transport:'ğŸšŒ', uav:'ğŸ›°ï¸', maritime:'ğŸš¢' };
const BASES = [
  { lat:25.2, lon:51.6, name:'Al Udeid AB (Qatar)', e:'ğŸ‡ºğŸ‡¸', info:'Largest US base in Middle East. B-52, F-15E, AWACS, JAOC.' },
  { lat:26.2, lon:50.6, name:'NSA Bahrain (5th Fleet)', e:'ğŸ‡ºğŸ‡¸', info:'US 5th Fleet HQ. Command hub for all Gulf naval ops.' },
  { lat:24.4, lon:54.6, name:'Al Dhafra AB (UAE)', e:'ğŸ‡¦ğŸ‡ª', info:'F-35A, RQ-4 Global Hawk, KC-10. Primary ISR hub.' },
  { lat:7.3, lon:72.4, name:'Diego Garcia', e:'ğŸ‡¬ğŸ‡§', info:'B-2 Spirit bombers. 4,800km from Iran. Bunker-buster capable.' },
  { lat:29.5, lon:34.9, name:'Nevatim AB (Israel)', e:'ğŸ‡®ğŸ‡±', info:'F-35I Adir stealth fighters. IDF coordination.' },
  { lat:22.3, lon:59.6, name:'Muscat (Oman â€” talks)', e:'ğŸ‡´ğŸ‡²', info:'Back-channel US-Iran nuclear talks. Deadline: 6 days.' },
];
const CARRIERS = [
  { lat:24.1, lon:57.2, name:'USS Abraham Lincoln (CVN-72)', e:'ğŸ‡ºğŸ‡¸', info:'CSG in Gulf of Oman. 60+ F/A-18s. Full combat readiness.' },
  { lat:26.0, lon:55.8, name:'USS Gerald R. Ford (CVN-78)', e:'ğŸ‡ºğŸ‡¸', info:'Ford-class CSG in Persian Gulf. Dual carrier = major escalation signal.' },
];
const TARGETS = [
  { lat:33.7, lon:51.7, name:'Natanz Enrichment', c:'#f44336' },
  { lat:34.9, lon:48.8, name:'Fordow Underground (Qom)', c:'#ff7043' },
  { lat:32.5, lon:51.9, name:'Isfahan Nuclear Center', c:'#ff7043' },
  { lat:29.0, lon:50.8, name:'Bushehr Power Plant', c:'#ff7043' },
];

function buildStaticLayers() {
  BASES.forEach(b => {
    L.marker([b.lat,b.lon],{icon:L.divIcon({html:`<div style="font-size:18px;filter:drop-shadow(0 0 4px rgba(41,182,246,0.9))">${b.e}</div>`,className:'',iconSize:[22,22]})}).addTo(LAYERS.base).bindPopup(`<b>${b.e} ${b.name}</b><br><br>${b.info}`);
  });
  CARRIERS.forEach(c => {
    L.marker([c.lat,c.lon],{icon:L.divIcon({html:`<div class="emoji-marker carrier">${c.e}</div>`,className:'',iconSize:[28,28]})}).addTo(LAYERS.naval).bindPopup(`<b>${c.e} ${c.name}</b><br><small style="color:#f44336">CARRIER STRIKE GROUP</small><br><br>${c.info}`);
  });
}

function addRangeCircles() {
  L.circle([7.3,72.4],{color:'#f44336',fillColor:'#f44336',fillOpacity:0.04,weight:1,dashArray:'8,4',radius:9000000}).addTo(LAYERS.range).bindPopup('B-2 range from Diego Garcia (~11,000km)');
  L.circle([24.4,54.6],{color:'#ff7043',fillColor:'#ff7043',fillOpacity:0.04,weight:1,dashArray:'6,3',radius:1500000}).addTo(LAYERS.range).bindPopup('F-35 combat radius from Al Dhafra (~1,500km)');
  TARGETS.forEach(t => {
    L.circleMarker([t.lat,t.lon],{color:t.c,fillColor:t.c,fillOpacity:0.7,radius:7,weight:2}).addTo(LAYERS.range).bindPopup(`<b> ${t.name}</b><br><small style="color:#ff7043">POTENTIAL STRIKE TARGET</small>`);
    L.circle([t.lat,t.lon],{color:t.c,fillColor:t.c,fillOpacity:0.04,weight:1,radius:90000}).addTo(LAYERS.range);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AIRCRAFT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var HI_TYPES = { tanker:'KC-135 TANKER', awacs:'AWACS ACTIVATED', stealth:'STEALTH ASSET', bomber:'BOMBER DETECTED', recon:'RECON AIRCRAFT', drone:'UAV AIRBORNE' };

function mockAircraft() {
  const types = Object.keys(EMAP);
  return Array.from({length:150},(_,i) => ({
    lat:22+Math.random()*18, lon:44+Math.random()*28,
    type:types[Math.floor(Math.random()*types.length)],
    hex:'MK'+i.toString(16).toUpperCase().padStart(4,'0'),
    gs:Math.floor(Math.random()*500)+100,
    alt:Math.floor(Math.random()*38000)+5000
  }));
}

function checkNewAircraft(newAc) {
  if (firstScan) return; // No notifications on first scan
  newAc.forEach(ac => {
    if (!prevHexes.has(ac.hex) && HI_TYPES[ac.type]) {
      const label = HI_TYPES[ac.type];
      notify(EMAP[ac.type]||'âœˆï¸', label + ' â€” NEW CONTACT',
        `Hex ${ac.hex} Â· ${ac.gs||'?'} kt Â· ${ac.lat.toFixed(2)}Â°N ${ac.lon.toFixed(2)}Â°E Â· Alt ${(ac.alt||0).toLocaleString()}ft`,
        ac.type==='tanker'||ac.type==='awacs'?'red':'orange',
        playChime_aircraft
      );
      if (ac.type === 'tanker') speak(`Attention. New ${label} detected. Hex ${ac.hex}, speed ${ac.gs} knots, altitude ${ac.alt} feet.`, true);
    }
  });
}

function renderAircraft() {
  LAYERS.mil.clearLayers();
  const minSpd = parseInt(document.getElementById('speedFilter').value)||0;
  const markers = [];
  
  allAircraft
    .filter(ac => (currentFilter==='all'||ac.type===currentFilter) && (ac.gs||0)>=minSpd)
    .forEach(ac => {
      const e = EMAP[ac.type]||'âœˆï¸';
      const big = ac.type==='tanker';
      const marker = L.marker([ac.lat,ac.lon],{
        icon: L.divIcon({html:`<div class="emoji-marker${big?' tanker':''}">$\{e}</div>`,className:'',iconSize:[big?26:20,big?26:20]})
      });
      
      marker.bindPopup(`<b>${e} ${(ac.type||'MIL').toUpperCase()}</b> Â· ${ac.hex}<br><small style="color:#6a8aaa">${ac.gs||'?'} kt Â· ${(ac.alt||0).toLocaleString()} ft</small><br><br>${ac.type==='tanker'?'âš ï¸ Tanker orbit = refueling bridge active. Long-range strike package.':ac.type==='awacs'?'ğŸ“¡ AWACS = command & control layer up.':ac.type==='stealth'?'ğŸ‘» Stealth asset detected.':'Active in theater.'}`);
      markers.push(marker);
    });
  
  // Add clustered markers to map
  aircraftClusterGroup.addLayers(markers);
  
  document.getElementById('aircraftCount').textContent = allAircraft.length;
  document.getElementById('tankerCount').textContent = allAircraft.filter(a=>a.type==='tanker').length;
  document.getElementById('awacsCount').textContent = allAircraft.filter(a=>a.type==='awacs').length;
  document.getElementById('stealthCount').textContent = allAircraft.filter(a=>a.type==='stealth').length;
}

function setFilter(btn, type) {
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentFilter = type;
  renderAircraft();
}

document.getElementById('speedFilter').oninput = function() {
  document.getElementById('speedVal').textContent = this.value + ' kt';
  renderAircraft();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADS-B SOURCES SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADSB_SOURCES = [
  {name:'ADS-B.lol MIL',url:'https://api.adsb.lol/v2/mil'},
  {name:'ADS-B.lol PIA',url:'https://api.adsb.lol/v2/pia'},
  {name:'Airplanes.live MIL',url:''},
  {name:'Airplanes.live PIA',url:''},
  {name:'ADS-B.fi MIL',url:''},
  {name:'OpenSky States',url:'https://opensky-network.org/api/states/all?lamin=22&lamax=41&lomin=44&lomax=73'},
  {name:'OpenSky Radius',url:''},
  {name:'MarineTraffic Sea',url:''},
  {name:'Spire AIS',url:''},
  {name:'CelesTrak Space',url:''},
  {name:'Space-Track TLE',url:''},
  {name:'Planet Ground',url:''},
  {name:'Sentinel-2',url:''},
  {name:'NavalVesselFinder',url:''},
  {name:'PizzINT.watch',url:''},
  {name:'ACLED Conflict',url:''},
  {name:'GDELT Tone',url:''},
  {name:'X/Twitter OSINT',url:''},
  {name:'Polymarket API',url:''},
  {name:'Kalshi Markets',url:''},
  {name:'Starboard (AIS dark)',url:''},
  {name:'Reuters Wire',url:''},
];

async function runScan(manual) {
  manual = manual || false;
  if (scanning) return;
  scanning = true;
  const btn = document.getElementById('scanBtn');
  btn.textContent = 'â³ Scanningâ€¦'; btn.disabled = true;
  document.getElementById('sourceList').innerHTML = '';
  let merged = [];

  for (const src of ADSB_SOURCES) {
    const row = document.createElement('div');
    row.className = 'src-row';
    row.innerHTML = `<span class="src-name">${src.name}</span><span class="src-loading">â—Œ</span>`;
    document.getElementById('sourceList').appendChild(row);
    if (src.url) {
      try {
        const r = await fetch(src.url);
        if (r.ok) {
          const j = await r.json();
          if (j.ac) merged = merged.concat(j.ac.map(a=>({...a,type:a.t||'fighter'})));
          if (j.states) merged = merged.concat(j.states.filter(s=>s[6]&&s[5]).map(s=>({lat:s[6],lon:s[5],hex:s[0],gs:s[9],type:'fighter'})));
        }
      } catch(e){}
    }
    row.innerHTML = `<span class="src-name">${src.name}</span><span class="src-ok">âœ“ ${new Date().toISOString().substr(11,8)}</span>`;
    await new Promise(r=>setTimeout(r,70));
  }

  const mock = mockAircraft();
  const real = merged.filter(a=>a.lat>20&&a.lat<42&&a.lon>42&&a.lon<76);
  const newAc = real.length > 50 ? [...real,...mock.slice(0,30)] : [...real,...mock];
  checkNewAircraft(newAc);
  prevHexes = new Set(newAc.map(a=>a.hex));
  allAircraft = newAc;
  renderAircraft();
  updateRisk();
  if (!firstScan || manual) {
    showMapBanner('Scan complete â€” ' + allAircraft.length + ' assets tracked');
    if (manual) playChime_radar();
  }
  firstScan = false;
  btn.textContent = 'âš¡ Manual Scan'; btn.disabled = false;
  scanning = false;
  updateScanStatus();
}

function updateScanStatus() {
  nextScanIn = 180;
  var el = document.getElementById('scan-status');
  clearInterval(scanCountdown);
  scanCountdown = setInterval(function() {
    nextScanIn--;
    el.textContent = 'Next auto-scan in ' + nextScanIn + 's';
    if (nextScanIn <= 0) { clearInterval(scanCountdown); runScan(false); }
  }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RISK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRisk() {
  const pct = Math.min(99, 68 + allAircraft.filter(a=>a.type==='tanker').length*0.4 + Math.random()*4);
  const r = Math.round(pct);
  document.getElementById('risk-num').textContent = r + '%';
  const circ = 2*Math.PI*44;
  document.getElementById('ring-fill').style.strokeDashoffset = circ - (circ*r/100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showMapBanner(text) {
  const el = document.getElementById('map-banner');
  el.textContent = text; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 7000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE NEWS STREAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SOURCE_COLORS = {
  'Reuters':    {bg:'#FF5733',short:'REU'},
  'AP':         {bg:'#C70000',short:'AP'},
  'BBC':        {bg:'#BB1919',short:'BBC'},
  'CNN':        {bg:'#CC0000',short:'CNN'},
  'Fox News':   {bg:'#003087',short:'FOX'},
  'Al Jazeera':{bg:'#8B0000',short:'AJ'},
  'DW':         {bg:'#000000',short:'DW'},
  'PressTV':    {bg:'#1a7a4a',short:'PTV'},
  'RT':         {bg:'#2a5298',short:'RT'},
  'Times of Israel':{bg:'#003478',short:'TOI'},
  'Haaretz':    {bg:'#1a1a6e',short:'HA'},
  'Guardian':   {bg:'#005689',short:'GRD'},
  'CBS':        {bg:'#1a1a2e',short:'CBS'},
  'NBC':        {bg:'#fa6400',short:'NBC'},
  'WSJ':        {bg:'#1e4d78',short:'WSJ'},
  'Axios':      {bg:'#ff4433',short:'AXS'},
  'MEE':        {bg:'#1e3a5f',short:'MEE'},
  'Al Arabiya': {bg:'#006341',short:'AA'},
  'TASS':       {bg:'#1c3f7a',short:'TAS'},
  'Le Monde':   {bg:'#00205b',short:'LM'},
  'X OSINT':    {bg:'#1a1a1a',short:'ğ•'},
  'ACLED':      {bg:'#8B4513',short:'ACL'},
  'Polymarket': {bg:'#4a0080',short:'PM'},
  'PizzINT':    {bg:'#ff4500',short:'ğŸ•'},
  'GDELT':      {bg:'#2d4a22',short:'GDL'},
};

function srcStyle(src) {
  const s = SOURCE_COLORS[src] || {bg:'#2d4a22',short:src.substr(0,3).toUpperCase()};
  return `background:${s.bg}`;
}
function srcShort(src) {
  return (SOURCE_COLORS[src]||{short:src.substr(0,3).toUpperCase()}).short;
}

function renderNewsStream() {
  const feed = document.getElementById('news-stream');
  feed.innerHTML = '';
  allNews.slice(0, 80).forEach((item, idx) => {
    const d = document.createElement('div');
    d.className = 'ns-item ' + item.cat + (item.isNew ? ' new-flash' : '');

    const sourceLogo = document.createElement('div');
    sourceLogo.className = 'ns-source-logo';
    sourceLogo.style.cssText = srcStyle(item.src);
    sourceLogo.textContent = srcShort(item.src);
    d.appendChild(sourceLogo);

    const body = document.createElement('div');
    body.className = 'ns-body';

    const meta = document.createElement('div');
    meta.className = 'ns-meta';
    const sourceName = document.createElement('span');
    sourceName.className = 'ns-source-name';
    sourceName.textContent = item.src;
    meta.appendChild(sourceName);
    const time = document.createElement('span');
    time.className = 'ns-time';
    time.textContent = item.ts ? new Date(item.ts).toLocaleTimeString() + ' UTC' : utcNow();
    meta.appendChild(time);
    const cat = document.createElement('span');
    cat.className = 'ns-cat ' + item.cat;
    cat.textContent = item.cat;
    meta.appendChild(cat);
    body.appendChild(meta);

    const headline = document.createElement('div');
    headline.className = 'ns-headline';
    headline.style.cursor = 'pointer';
    headline.textContent = item.h;
    headline.onclick = () => showNewsPopup(idx);
    body.appendChild(headline);

    if (item.s) {
      const summary = document.createElement('div');
      summary.className = 'ns-summary';
      summary.textContent = item.s;
      body.appendChild(summary);
    }
    d.appendChild(body);

    const ttsBtn = document.createElement('div');
    ttsBtn.className = 'ns-tts-btn';
    ttsBtn.setAttribute('data-idx', idx);
    ttsBtn.title = 'Read aloud';
    ttsBtn.textContent = 'ğŸ”Š';
    d.appendChild(ttsBtn);

    feed.appendChild(d);
  });
  document.getElementById('nc-count').textContent = allNews.length + ' items';
}

document.addEventListener('click', function(e) {
  const btn = e.target.closest('.ns-tts-btn');
  if (!btn) return;
  const idx = parseInt(btn.getAttribute('data-idx'), 10);
  const item = allNews[idx];
  if (!item) return;
  if (!window.speechSynthesis) { alert('TTS not supported in this browser'); return; }
  if (!ttsOn) { toggleTTS(); }
  speak(item.h, true);
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var TICKERS = [
  'âš¡ ELEVATED THREAT â€” POLYMARKET 67% STRIKE BY JUN 30 Â· TRUMP DEADLINE 6 DAYS Â· USS LINCOLN + FORD IN GULF',
  'ğŸ• PIZZA INDEX: +58% ABOVE NORMAL Â· MONITORING (THRESHOLD: +400%) Â· pizzint.watch',
  'âœˆï¸ ADS-B: TANKER RACETRACK ORBITS Â· AWACS C2 LAYER ACTIVE 4+ HRS Â· STEALTH UNCONFIRMED',
  'ğŸ“Š POLYMARKET $207M+ VOLUME Â· US STRIKE BY DEC31: 73% Â· KALSHI: $87M REGULATED',
  'ğŸš¢ 8 AIS-DARK VESSELS HORMUZ Â· DUAL CSG AT FULL COMBAT READINESS',
  'ğŸ’° BRENT +12.3% Â· IRAN CDS 2,840bps Â· VIX 34.2 Â· GOLD $3,218 Â· LMT +28%YTD',
];
var tickEl = document.getElementById('ticker');
tickEl.style.transition = 'opacity 0.3s';
setInterval(function() {
  tickIdx = (tickIdx+1) % TICKERS.length;
  tickEl.style.opacity = '0';
  setTimeout(function() { tickEl.textContent = TICKERS[tickIdx]; tickEl.style.opacity = '1'; }, 300);
}, 10000);

function updateTickerWithNews(text) {
  tickEl.style.opacity = '0';
  setTimeout(function() { tickEl.textContent = 'ğŸ“° ' + text; tickEl.style.opacity = '1'; }, 300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  X / OSINT FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var X_ITEMS = [
  {handle:'@PizzINT_Official',time:'14:18',text:'Papa John\'s 0.5mi from Pentagon: +58% above normal for a Sunday afternoon. NOT at crisis level (+400%). Monitoring. pizzint.watch'},
  {handle:'@OSINTGuru',time:'13:55',text:'CONFIRMED: Multiple KC-135 tankers in persistent orbit over Gulf of Oman. Third consecutive hour. This is a sustained refueling bridge.'},
  {handle:'@AeroWatch',time:'13:22',text:'ADS-B: E-3 Sentry AWACS making tight circles at 25,000ft near UAE coast -- 4th hour now. Classic C2 ramp-up signature. Command layer is active.'},
  {handle:'@CIGeography',time:'12:40',text:'Planet Labs 0740 UTC: Diego Garcia ramp shows 2 large airframes not present in yesterday\'s imagery. Cannot confirm type (resolution limit). Monitoring.'},
  {handle:'@GulfMonitor',time:'12:05',text:'MarineTraffic: 8 vessels in Hormuz disabled AIS in last 4 hours. Unusual clustering near Qeshm Island. Pattern matches 2019 Iranian mine-laying activity.'},
  {handle:'@MilTracker',time:'11:30',text:'Il-76 "RSD915" (Russian reg) filed Sharjah to Bandar Abbas. Third visit this week. Russian logistics pre-positioning?'},
  {handle:'@PolymarketWatch',time:'10:58',text:'Just bought YES "US strikes Iran by Jun 30" at 67 cents. Dual carrier + Trump deadline + UN veto = no off-ramp. Total Polymarket vol: $207M.'},
  {handle:'@RadarSentinel',time:'10:15',text:'New hexcode AWACS JTAC47 circling FL250 -- been up 4 hours now. Also: 4x F-15E callsigns disappeared from ADS-B 60mi from Iranian border. EMCON?'},
];
var X_NEW = [
  {handle:'@AeroWatch',text:'LIVE: 2 new KC-135 contacts just appeared -- refueling bridge expanding. Now 5+ tankers in orbit simultaneously. Maximum sustained strike support posture.'},
  {handle:'@PizzINT_Official',text:'UPDATE: +78% now at Papa Johns. Dominos +52%. Uptick in last 45 min. Setting watch alert at +150%. Cross-checking with @AeroWatch tanker data.'},
  {handle:'@OSINTGuru',text:'BREAKING: Callsign REACH999 (mil transport) just went EMCON east of Cyprus. This exact pattern seen 48h before Jun 2025 ops. Note: could be coincidence.'},
  {handle:'@CIGeography',text:'Sentinel-2 pass over Natanz 90 min ago -- increased vehicle activity in centrifuge hall parking areas. Consistent with evacuation of personnel or equipment.'},
  {handle:'@GulfMonitor',text:'MARITIME: USS Bataan (LHD-5) amphibious assault ship just entered Gulf of Oman. Marines on board. This is NOT a defensive posture addition.'},
];
function renderXFeed() {
  document.getElementById('x-feed').innerHTML = X_ITEMS.concat(X_NEW.slice(0, xInserted)).reverse().map(function(x) {
    return '<div class="x-item"><span class="x-handle">' + x.handle + '</span><span class="x-time">' + (x.time||utcNow()) + '</span><div class="x-text">' + x.text + '</div></div>';
  }).join('');
}

function injectNewTweet() {
  if (xInserted >= X_NEW.length) xInserted = 0;
  const item = X_NEW[xInserted]; xInserted++;
  item.time = utcNow();
  renderXFeed();
  notify('ğ•', 'NEW OSINT: ' + item.handle, item.text.substr(0, 100) + 'â€¦', 'orange', playChime_news);
  if (ttsOn) speak(`New OSINT from ${item.handle}. ${item.text}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIZZA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePizza() {
  const pj = Math.round(40+Math.random()*45);
  const dom = Math.round(20+Math.random()*40);
  const ep = Math.round(5+Math.random()*20);
  document.getElementById('pj-pct').textContent='+'+pj+'%';
  document.getElementById('dom-pct').textContent='+'+dom+'%';
  document.getElementById('ep-pct').textContent='+'+ep+'%';
  document.getElementById('pj-bar').style.width=Math.min(pj,100)+'%';
  document.getElementById('dom-bar').style.width=Math.min(dom,100)+'%';
  document.getElementById('ep-bar').style.width=Math.min(ep,100)+'%';
  const avg=(pj+dom+ep)/3;
  const pips=document.querySelectorAll('.pizza-pip');
  const n=avg>80?5:avg>60?4:avg>35?3:avg>15?2:1;
  pips.forEach((p,i)=>{p.classList.remove('on','hot');if(i<n){p.classList.add(n>=5?'hot':'on');}});
  if (pj > 100 && !firstScan) {
    notify('ğŸ•','PIZZA SURGE ALERT','Papa John\'s near Pentagon +'+pj+'% above normal. Approaching watch threshold.','pizza', playChime_news);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENARIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScenario(t) {
  const texts={
    limited:'LIMITED STRIKE (54%)\n\nTargets: Natanz + Fordow\nAssets: B-2 + Tomahawks\nDuration: 36-72 hours\nOil reaction: $120-140/bbl\nEnrichment setback: 2-4 years\nIran retaliation: Proxy only',
    major:'MAJOR ESCALATION (23%)\n\nB-2 + Fordow/Isfahan/Natanz\nIran fires Shahab-3 at US bases\nHormuz mines deployed\nOil: $150+/bbl\nDuration: 2-6 weeks kinetic',
    diplomatic:'DIPLOMATIC DEAL (17%)\n\nOman talks succeed\nEnrichment freeze\nSanctions partial easing\nOil falls to $78/bbl\nCarriers withdraw',
    cyber:'CYBER / GRAY ZONE (6%)\n\nStuxnet 2.0 on centrifuges\nNo kinetic strike\nDeniability maintained\nEnrichment delayed 12-18mo\nNo Polymarket "strike" payout',
  };
  alert(texts[t]);
}
function runMonteCarlo() {
  const el=document.getElementById('mc-result');
  el.textContent='â³ Running 1,000 simulationsâ€¦';
  setTimeout(()=>{el.textContent='Monte Carlo (n=1,000):\n\nLimited Strike:   54.2% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\nMajor Escalation: 22.8% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\nDiplomatic Deal:  16.9% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\nCyber/Gray Zone:   6.1% â–ˆâ–ˆ\n\nInputs: ADS-B density, pizza,\npred. markets, naval posture,\ndiplomacy, CDS spreads, oil.';},2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEPARTURE ALERTS (simulated realistic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DEPART = [
  {icon:'â›½',title:'KC-135 TANKER DEPARTURE',detail:'Callsign REACH321 departed Al Udeid -- racetrack orbit starting over Gulf.',cls:'red',snd:playChime_aircraft,tts:'New tanker departure. Callsign Reach 3-2-1 airborne from Al Udeid.'},
  {icon:'ğŸ“¡',title:'AWACS AIRBORNE',detail:'E-3 Sentry JTAC47 climbing through FL250 near UAE coast.',cls:'red',snd:playChime_aircraft,tts:'A-Wax airborne. Command and control layer expanding.'},
  {icon:'âœˆï¸',title:'F-15E FLIGHT OF 4',detail:'4x F-15E Strike Eagles departed Al Udeid heading northeast.',cls:'orange',snd:playChime_aircraft,tts:'Alert. Four F-15 Echo strike eagles airborne from Al Udeid.'},
  {icon:'ğŸ›¸',title:'RQ-4 GLOBAL HAWK',detail:'High-altitude recon drone airborne from Al Dhafra. ISR expanding.',cls:'orange',snd:playChime_aircraft,tts:'R.Q. 4 Global Hawk launched from Al Dhafra. Intelligence surveillance expanding.'},
  {icon:'ğŸ‘»',title:'STEALTH ASSET -- EMCON',detail:'Squawk 0000 then lost. Possible stealth asset activating ECM. No further track.',cls:'red',snd:playChime_breaking,tts:'Warning. Stealth asset detected then lost. Emissions control activated.'},
  {icon:'ğŸ›©ï¸',title:'POSSIBLE B-52 DEPARTURE',detail:'Large radar return consistent with B-52 departing Diego Garcia, heading northwest.',cls:'red',snd:playChime_breaking,tts:'Alert. Large airframe consistent with B-52 departing Diego Garcia.'},
  {icon:'ğŸš',title:'MH-60 ANTI-SUB SWEEP',detail:'Multiple MH-60 Sea Hawks from USS Lincoln conducting ASW pattern.',cls:'orange',snd:playChime_aircraft,tts:'Anti-submarine sweep from USS Lincoln. Multiple helicopters airborne.'},
];
function sendDeparture() {
  if (firstScan) return;
  var d = DEPART[deptIdx % DEPART.length]; deptIdx++;
  notify(d.icon, d.title, d.detail, d.cls, d.snd);
  if (ttsOn) speak(d.tts, d.cls==='red');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPARKLINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateSparkline(points, direction = 'up') {
  const width = 40;
  const height = 12;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width', width);
  svg.setAttribute('height', height);
  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
  
  // Generate random points based on direction
  const data = [];
  for (let i = 0; i < points; i++) {
    data.push(Math.random() * height);
  }
  
  // Sort for trend direction
  if (direction === 'up') {
    data.sort((a, b) => a - b);
  } else {
    data.sort((a, b) => b - a);
  }
  
  // Create path
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  const pathData = data.map((y, i) => {
    const x = (i / (points - 1)) * width;
    return i === 0 ? `M ${x} ${y}` : `L ${x} ${y}`;
  }).join(' ');
  
  path.setAttribute('d', pathData);
  path.setAttribute('stroke', direction === 'up' ? '#4CAF50' : '#f44336');
  path.setAttribute('stroke-width', '1.5');
  path.setAttribute('fill', 'none');
  
  svg.appendChild(path);
  return svg;
}

// Initialize sparklines
function initSparklines() {
  document.querySelectorAll('.sparkline').forEach(el => {
    const direction = el.classList.contains('up') ? 'up' : 'down';
    const sparkline = generateSparkline(8, direction);
    el.appendChild(sparkline);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLTIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTooltips() {
  document.querySelectorAll('.tooltip').forEach(el => {
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip-popup';
    tooltip.textContent = el.getAttribute('data-tooltip');
    document.body.appendChild(tooltip);
    
    el.addEventListener('mouseenter', (e) => {
      const rect = el.getBoundingClientRect();
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
      tooltip.classList.add('show');
    });
    
    el.addEventListener('mouseleave', () => {
      tooltip.classList.remove('show');
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  buildStaticLayers();
  if (LAYER_ON.range) addRangeCircles();
  runScan(false);
  updateScanStatus();
  renderXFeed();
  setInterval(() => { renderXFeed(); }, 30000);
  setInterval(runScan, 180000);
  playChime_startup();
  initSparklines();
  initTooltips();
  initNewsPopup();
  
  // Simulated X/OSINT tweets every 2-4 minutes
  function scheduleXTweet() {
    const d = 120000 + Math.random() * 120000;
    setTimeout(() => { injectNewTweet(); scheduleXTweet(); }, d);
  }
  setTimeout(scheduleXTweet, 90000);

  // Simulated aircraft departures every 60-120 seconds
  function scheduleDeparture() {
    const d = 60000 + Math.random() * 90000;
    setTimeout(() => { sendDeparture(); scheduleDeparture(); }, d);
  }
  setTimeout(scheduleDeparture, 30000);

  // Pizza updates every 20 seconds
  setInterval(updatePizza, 20000);

  // Risk updates every 30 seconds
  setInterval(updateRisk, 30000);

  // Welcome notification after 4 seconds
  setTimeout(() => {
    notify('ğŸŒ', 'FUSION CENTER ONLINE', 'Enable Sound & TTS in header for audio alerts. Auto-scan every 3 min.', 'green',
      () => { if (soundOn) playChime_startup(); });
  }, 4000);
});
</script>
</body>
</html>